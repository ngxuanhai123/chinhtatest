<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>HiHi - Luy·ªán Ch√≠nh T·∫£ Th√¥ng Minh (AI Edition)</title>
  <meta name="description" content="Luy·ªán g√µ chu·∫©n, nghe r√µ, ƒë·ªçc to ‚Äì nh·∫≠n di·ªán gi·ªçng n√≥i, karaoke, t·∫°o ƒë·ªÅ b√†i b·∫±ng AI.">
  <meta name="theme-color" content="#8b5cf6">
  <link href="https://googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700;800&family=Outfit:wght@400;600;800&family=Mountains+of+Christmas:wght@700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  
  <style>
    :root {
      /* --- M√ÄU S·∫ÆC HI·ªÜN ƒê·∫†I (DEFAULT) --- */
      --bg-gradient: radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), 
                     radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), 
                     radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
      --bg-color: #0f172a;
      
      --glass-surface: rgba(255, 255, 255, 0.75);
      --glass-border: rgba(255, 255, 255, 0.4);
      --glass-blur: 20px;

      --text: #1e293b; 
      --text-dim: #64748b;
      
      /* Gradient ch·ªß ƒë·∫°o: Violet -> Pink */
      --primary-gradient: linear-gradient(135deg, #8b5cf6 0%, #ec4899 100%);
      --primary-shadow: rgba(139, 92, 246, 0.4);
      --primary: #8b5cf6;
      
      --success: #10b981; 
      --danger: #ef4444;
      --warning: #f59e0b;
      --info: #3b82f6;

      --card-radius: 24px;
      --input-radius: 16px;
      --btn-radius: 16px;
      
      --font-main: 'Be Vietnam Pro', sans-serif;
      --font-display: 'Outfit', sans-serif;
      
      --shadow-sm: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
      --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.05);
      --shadow-glow: 0 0 20px rgba(139, 92, 246, 0.3);
    }

    /* DARK MODE */
    [data-theme="dark"] {
      --bg-color: #020617;
      --glass-surface: rgba(15, 23, 42, 0.65); /* T·ªëi m√†u v√† trong su·ªët */
      --glass-border: rgba(255, 255, 255, 0.08);
      --text: #f8fafc;
      --text-dim: #94a3b8;
      --shadow-lg: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    }

    /* HOLIDAY MODE */
    [data-theme*="holiday"] {
      --primary-gradient: linear-gradient(135deg, #dc2626 0%, #16a34a 100%); /* ƒê·ªè - Xanh */
      --primary-shadow: rgba(220, 38, 38, 0.4);
      --primary: #dc2626;
      --bg-color: #0f2b1d;
      --font-display: 'Mountains of Christmas', cursive;
    }
    [data-theme="holiday"] {
      --glass-surface: rgba(255, 255, 255, 0.85);
    }
    [data-theme="holiday-dark"] {
      --glass-surface: rgba(20, 10, 10, 0.75);
      --text: #ffe4e6;
      --bg-color: #1a0505;
    }

    /* --- RESET & BASE --- */
    * { margin:0; padding:0; box-sizing:border-box; -webkit-font-smoothing: antialiased; }
    
    body {
      font-family: var(--font-main);
      background-color: var(--bg-color);
      color: var(--text);
      min-height: 100vh;
      padding: 20px;
      line-height: 1.6;
      overflow-x: hidden;
      position: relative;
      transition: background-color 0.5s ease, color 0.3s ease;
    }

    /* BACKGROUND ANIMATION (AURORA) */
    .aurora-bg {
      position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
      z-index: -1; overflow: hidden; pointer-events: none;
    }
    .aurora-blob {
      position: absolute; filter: blur(80px); opacity: 0.6;
      animation: floatBlob 20s infinite alternate cubic-bezier(0.4, 0, 0.2, 1);
    }
    .blob-1 { top: -10%; left: -10%; width: 50vw; height: 50vw; background: #8b5cf6; animation-delay: 0s; }
    .blob-2 { bottom: -10%; right: -10%; width: 60vw; height: 60vw; background: #ec4899; animation-delay: -5s; }
    .blob-3 { top: 40%; left: 40%; width: 40vw; height: 40vw; background: #3b82f6; animation-delay: -10s; }
    
    [data-theme*="holiday"] .blob-1 { background: #dc2626; }
    [data-theme*="holiday"] .blob-2 { background: #16a34a; }
    [data-theme*="holiday"] .blob-3 { background: #fbbf24; }

    @keyframes floatBlob {
      0% { transform: translate(0, 0) scale(1); }
      100% { transform: translate(20px, 40px) scale(1.1); }
    }

    /* SNOWFLAKES */
    .snowflake {
      position: fixed; top: -10px; z-index: 999; color: #fff; 
      text-shadow: 0 0 5px rgba(255,255,255,0.8); pointer-events: none;
      animation: fall linear forwards; display: none;
    }
    [data-theme*="holiday"] .snowflake { display: block; }
    @keyframes fall { to { transform: translateY(105vh) rotate(360deg); } }

    /* LAYOUT CONTAINER */
    .container {
      max-width: 1100px; margin: 0 auto;
      display: flex; flex-direction: column; gap: 32px;
      position: relative; z-index: 10;
      padding-top: 40px;
    }

    /* GLASS CARD STYLE */
    .glass-card {
      background: var(--glass-surface);
      backdrop-filter: blur(var(--glass-blur));
      -webkit-backdrop-filter: blur(var(--glass-blur));
      border: 1px solid var(--glass-border);
      border-radius: var(--card-radius);
      box-shadow: var(--shadow-lg);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    /* HEADER */
    header {
      padding: 40px 30px;
      text-align: center;
      position: relative;
      overflow: hidden;
    }
    header::before {
      content: ''; position: absolute; top:0; left:0; right:0; height: 6px;
      background: var(--primary-gradient);
    }
    
    .logo {
      display: flex; align-items: center; justify-content: center; gap: 12px;
      margin-bottom: 8px;
    }
    .logo svg { width: 50px; height: 50px; fill: url(#grad1); animation: floatLogo 6s ease-in-out infinite; }
    
    .logo h1 {
      font-family: var(--font-display);
      font-size: 3.5rem; font-weight: 800; letter-spacing: -0.03em;
      background: var(--primary-gradient);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      line-height: 1.1;
    }
    .tagline {
      color: var(--text-dim); font-size: 1.1rem; font-weight: 500;
    }
    
    @keyframes floatLogo { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-8px) rotate(2deg)} }

    /* BUTTONS & CONTROLS */
    .theme-toggle-wrapper {
      position: absolute; top: 20px; right: 20px; display: flex; gap: 12px;
    }
    .icon-btn {
      width: 44px; height: 44px; border-radius: 50%; border: none;
      background: var(--glass-surface); color: var(--text);
      border: 1px solid var(--glass-border); cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      transition: 0.3s; box-shadow: var(--shadow-sm);
      font-size: 1.2rem;
    }
    .icon-btn:hover { transform: scale(1.1); background: var(--text); color: var(--bg-color); }
    
    #logoutBtn { color: var(--danger); }
    #logoutBtn:hover { background: var(--danger); color: white; }
    #holidayBtn { color: #16a34a; }
    [data-theme*="holiday"] #holidayBtn { background: #dc2626; color: #fff; border-color: #fbbf24; }

    /* TABS */
    .tabs {
      display: inline-flex; background: var(--glass-surface);
      padding: 6px; border-radius: 20px; border: 1px solid var(--glass-border);
      margin: 0 auto; position: relative;
      box-shadow: var(--shadow-sm);
    }
    .tab {
      padding: 12px 32px; border-radius: 14px; border: none;
      background: transparent; color: var(--text-dim);
      font-weight: 600; font-size: 1rem; cursor: pointer;
      transition: 0.3s; font-family: var(--font-main);
    }
    .tab.active {
      background: var(--primary-gradient); color: white;
      box-shadow: 0 4px 12px var(--primary-shadow);
    }

    /* INPUT NAME */
    .name-box { text-align: center; margin-bottom: 10px; }
    .name-box input {
      background: transparent; border: none; border-bottom: 2px solid var(--glass-border);
      text-align: center; font-size: 1.2rem; color: var(--text); font-weight: 700;
      width: 300px; padding: 8px; font-family: var(--font-display);
    }
    .name-box input:focus { outline: none; border-color: var(--primary); }

    /* SETUP GRID */
    .setup-grid {
      padding: 40px;
      display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 24px;
    }
    .setup-item {
      background: rgba(255,255,255,0.05); border-radius: var(--input-radius);
      padding: 24px; border: 1px solid var(--glass-border);
    }
    .setup-item h3 {
      font-size: 1.1rem; margin-bottom: 16px; color: var(--primary);
      display: flex; align-items: center; gap: 8px; font-weight: 700;
    }
    .setup-item h3 svg { width: 20px; fill: var(--primary); }

    select, textarea, input[type="text"], input[type="password"] {
      width: 100%; padding: 14px 16px;
      border: 2px solid var(--glass-border); border-radius: var(--input-radius);
      background: rgba(255,255,255,0.5); color: #0f172a; /* Lu√¥n t·ªëi ƒë·ªÉ d·ªÖ ƒë·ªçc tr√™n n·ªÅn k√≠nh */
      font-family: var(--font-main); font-size: 1rem; transition: 0.3s;
    }
    [data-theme="dark"] select, [data-theme="dark"] textarea, [data-theme="dark"] input[type="text"], [data-theme="dark"] input[type="password"] {
       background: rgba(0,0,0,0.3); color: #fff; border-color: rgba(255,255,255,0.1);
    }

    select:focus, textarea:focus, input[type="text"]:focus, input[type="password"]:focus {
      outline: none; border-color: var(--primary);
      box-shadow: 0 0 0 4px var(--primary-shadow);
    }

    /* RADIO CUSTOM */
    .radio-group { display: flex; flex-direction: column; gap: 10px; }
    .radio-label {
      display: flex; align-items: center; gap: 12px; padding: 12px;
      border-radius: 12px; cursor: pointer; transition: 0.2s;
      border: 1px solid transparent;
    }
    .radio-label:hover { background: rgba(139, 92, 246, 0.1); }
    .radio-label:has(input:checked) {
      background: rgba(139, 92, 246, 0.15); border-color: var(--primary); font-weight: 600;
    }
    input[type="radio"] { accent-color: var(--primary); width: 18px; height: 18px; }

    /* MAIN BUTTON */
    .start-btn {
      grid-column: 1/-1;
      margin-top: 10px; padding: 20px;
      background: var(--primary-gradient);
      color: white; font-weight: 700; font-size: 1.25rem;
      border: none; border-radius: var(--btn-radius);
      cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;
      box-shadow: 0 10px 20px var(--primary-shadow);
      transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      text-transform: uppercase; letter-spacing: 1px;
    }
    .start-btn:hover { transform: translateY(-4px) scale(1.02); box-shadow: 0 15px 30px var(--primary-shadow); }
    .start-btn:active { transform: translateY(-1px); }

    /* PRACTICE AREA */
    #practiceArea, #rankPanel { padding: 40px; }
    
    .mode-switcher { display: flex; justify-content: center; gap: 8px; margin-bottom: 24px; }
    .mode-btn {
      padding: 8px 20px; border-radius: 30px; border: 1px solid var(--glass-border);
      background: transparent; color: var(--text); font-weight: 600; cursor: pointer;
      transition: 0.3s; font-size: 0.9rem;
    }
    .mode-btn.active { background: var(--text); color: var(--bg-color); border-color: transparent; }

    .progress-box { margin-bottom: 20px; }
    .progress-bar {
      height: 12px; background: rgba(0,0,0,0.1); border-radius: 10px; overflow: hidden;
    }
    [data-theme="dark"] .progress-bar { background: rgba(255,255,255,0.1); }
    .progress-fill {
      height: 100%; background: var(--primary-gradient); width: 0;
      border-radius: 10px; transition: width 0.5s ease;
    }

    .segment-box {
      font-size: 1.6rem; line-height: 1.8; text-align: center;
      min-height: 160px; padding: 40px;
      background: rgba(255,255,255,0.5); border-radius: 20px;
      border: 2px dashed var(--primary); margin-bottom: 24px;
      color: var(--text); font-weight: 600;
      display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 8px;
    }
    [data-theme="dark"] .segment-box { background: rgba(0,0,0,0.2); border-color: var(--text-dim); }
    
    .karaoke-word {
      padding: 4px 8px; border-radius: 8px; transition: 0.2s; position: relative;
    }
    .karaoke-active {
      background: var(--primary); color: white !important; transform: scale(1.1);
      box-shadow: 0 4px 12px var(--primary-shadow); z-index: 10;
    }
    .word-tooltip {
        position: absolute; bottom: 110%; left: 50%; transform: translateX(-50%);
        background: #1e293b; color: white; padding: 4px 8px; border-radius: 6px;
        font-size: 0.8rem; opacity: 0; pointer-events: none; transition: 0.2s;
        white-space: nowrap;
    }
    .karaoke-word:hover .word-tooltip { opacity: 1; transform: translateX(-50%) translateY(-5px); }

    .input-wrapper { position: relative; margin: 30px 0; }
    #userInput {
      font-size: 1.5rem; padding: 20px 60px 20px 24px;
      border-radius: 24px; border: 2px solid var(--glass-border);
      box-shadow: var(--shadow-sm);
    }
    .hint-btn {
      position: absolute; right: 16px; top: 50%; transform: translateY(-50%);
      width: 40px; height: 40px; border-radius: 12px;
      background: #8b5cf6; color: white; border: none; font-weight: bold;
      cursor: pointer; display: flex; align-items: center; justify-content: center;
    }

    #liveFeedback {
      font-family: 'Courier New', monospace; font-size: 1.2rem;
      min-height: 50px; margin-bottom: 30px; color: var(--text-dim);
    }
    .correct { color: var(--success); font-weight: 700; }
    .wrong { color: var(--danger); text-decoration: line-through; opacity: 0.7; }

    /* ACTION BUTTONS */
    .action-row { display: flex; justify-content: center; gap: 16px; flex-wrap: wrap; }
    .action-btn {
      padding: 16px 32px; border-radius: 16px; border: none;
      font-weight: 700; font-size: 1rem; cursor: pointer;
      display: flex; align-items: center; gap: 10px; transition: 0.3s;
      color: white; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    .action-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }
    .action-btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0,0,0,0.15); }

    .btn-replay { background: var(--warning); }
    .btn-next { background: var(--success); }
    .btn-reset { background: var(--glass-surface); color: var(--text); border: 1px solid var(--glass-border); }
    
    /* AI BUTTON */
    #aiGenBtn {
      background: var(--primary-gradient);
      padding: 14px;
      border-radius: 12px;
      font-weight: bold;
      color: white;
      border: none;
      cursor: pointer;
      transition: 0.3s;
    }
    #aiGenBtn:disabled { opacity: 0.6; cursor: wait; }
    #aiGenBtn:hover:not(:disabled) { box-shadow: 0 5px 15px var(--primary-shadow); }

    /* STATS */
    .stats-row {
      display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-top: 40px;
    }
    .stat-item {
      background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border);
      padding: 16px; border-radius: 16px; text-align: center;
    }
    .stat-item h4 { font-size: 0.85rem; color: var(--text-dim); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; }
    .stat-item .val { font-size: 1.8rem; font-weight: 800; color: var(--primary); font-family: var(--font-display); }

    /* BADGE & MODAL */
    .level-badge {
      display: inline-block; padding: 8px 24px; border-radius: 30px;
      background: var(--primary-gradient); color: white; font-weight: 700;
      box-shadow: var(--shadow-glow); margin-top: 20px;
    }

    .modal {
      position: fixed; top:0; left:0; width:100%; height:100%; z-index: 2000;
      background: rgba(0,0,0,0.6); backdrop-filter: blur(5px);
      display: flex; align-items: center; justify-content: center;
      opacity: 0; visibility: hidden; transition: 0.3s;
    }
    .modal.show { opacity: 1; visibility: visible; }
    .modal-content {
      background: var(--bg-color); border: 1px solid var(--glass-border);
      padding: 40px; border-radius: 32px; width: 90%; max-width: 450px;
      text-align: center; box-shadow: var(--shadow-lg);
    }
    .modal h3 { font-family: var(--font-display); font-size: 1.8rem; margin-bottom: 24px; color: var(--primary); }

    /* RESPONSIVE */
    @media (max-width: 768px) {
      .logo h1 { font-size: 2.5rem; }
      .stats-row { grid-template-columns: 1fr 1fr; }
      .setup-grid { grid-template-columns: 1fr; padding: 24px; }
      #userInput { font-size: 1.2rem; }
    }

    /* UTILS */
    .hidden { display: none !important; }
    .mic-btn {
      width: 70px; height: 70px; border-radius: 50%; background: var(--danger); color: white;
      font-size: 2rem; border: none; cursor: pointer; margin: 0 auto 20px; display: block;
      transition: 0.3s; box-shadow: 0 8px 20px rgba(239, 68, 68, 0.4);
    }
    .mic-btn.listening { background: var(--success); animation: pulseMic 1.5s infinite; }
    @keyframes pulseMic { 0% { box-shadow: 0 0 0 0 rgba(16,185,129,0.7); } 70% { box-shadow: 0 0 0 20px transparent; } 100% { box-shadow: 0 0 0 0 transparent; } }

    /* SVG Gradients Defs (Hidden visually but used) */
    .svg-defs { width: 0; height: 0; position: absolute; }
  </style>
</head>
<body>

  <div class="aurora-bg">
    <div class="aurora-blob blob-1"></div>
    <div class="aurora-blob blob-2"></div>
    <div class="aurora-blob blob-3"></div>
  </div>
  
  <div id="snowContainer"></div>
  
  <svg class="svg-defs">
    <defs>
      <linearGradient id="grad1" x1="0%" y1="0%" x2="100%" y2="0%">
        <stop offset="0%" style="stop-color:#8b5cf6;stop-opacity:1" />
        <stop offset="100%" style="stop-color:#ec4899;stop-opacity:1" />
      </linearGradient>
    </defs>
  </svg>

  <div id="browserWarning" style="display:none; background:#fef3c7; color:#92400e; padding:10px; text-align:center; font-weight:600;">
    ‚ö†Ô∏è Web ch·∫°y t·ªët nh·∫•t tr√™n Chrome/Edge PC
    <span class="close-warn" onclick="this.parentElement.style.display='none'" style="cursor:pointer; margin-left:10px;">&times;</span>
  </div>

  <div class="container">
    <header class="glass-card">
      <div class="theme-toggle-wrapper">
        <button class="icon-btn" id="holidayBtn" title="Ch·∫ø ƒë·ªô Gi√°ng Sinh">üéÑ</button>
        <button class="icon-btn" id="themeBtn" title="ƒê·ªïi giao di·ªán S√°ng/T·ªëi">
           <span id="sunIcon">‚òÄÔ∏è</span><span id="moonIcon" class="hidden">üåô</span>
        </button>
        <div id="logoutBtnWrapper" class="hidden">
            <button class="icon-btn" id="logoutBtn" title="ƒêƒÉng xu·∫•t">üö™</button>
        </div>
      </div>

      <div class="logo">
        <svg viewBox="0 0 24 24">
          <path d="M20 2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h14l4 4V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/>
        </svg>
        <h1>HiHi<span style="font-size:0.4em; vertical-align: super; opacity: 0.8;">2026</span></h1>
      </div>
      <p class="tagline">Luy·ªán ch√≠nh t·∫£ & ngo·∫°i ng·ªØ c√πng AI üöÄ</p>
    </header>

    <div class="tabs">
      <button class="tab active" data-tab="setupPanel">Luy·ªán T·∫≠p</button>
      <button class="tab" data-tab="rankPanel">Th·ªëng K√™</button>
    </div>

    <div class="name-box">
      <input type="text" id="playerName" placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n..." maxlength="20" readonly />
    </div>

    <div id="setupPanel" class="tab-content glass-card">
      <div class="setup-grid">
        <div class="setup-item">
          <h3>üåç Ng√¥n ng·ªØ</h3>
          <select id="globalLang">
            <option value="vi-VN">Ti·∫øng Vi·ªát (G·ªëc)</option>
            <option value="en-US">Ti·∫øng Anh ‚Üí Vi·ªát</option>
            <option value="id-ID">Ti·∫øng Indonesia ‚Üí Vi·ªát</option>
          </select>
        </div>

        <div class="setup-item">
          <h3>üéÆ Ch·∫ø ƒë·ªô ch∆°i</h3>
          <div class="radio-group">
            <label class="radio-label"><input type="radio" name="mode" value="read-write" checked> <span>Nh√¨n & Ch√©p</span></label>
            <label class="radio-label"><input type="radio" name="mode" value="listen-write"> <span>Nghe & Ch√©p</span></label>
            <label class="radio-label"><input type="radio" name="mode" value="read-listen-write"> <span>Nghe - Nh√¨n - Ch√©p</span></label>
            <label class="radio-label"><input type="radio" name="mode" value="read-only"> <span>Luy·ªán ƒê·ªçc (Mic)</span></label>
          </div>
        </div>
        
        <div class="setup-item">
          <h3>üîä Gi·ªçng ƒë·ªçc AI</h3>
          <div style="display:flex; flex-direction:column; gap:12px;">
             <select id="voiceSelect"></select>
             <div style="display:flex; gap:10px;">
                 <select id="voiceRateSelect" style="flex:1;">
                    <option value="0.75">0.75x (Ch·∫≠m)</option>
                    <option value="1.00" selected>1.00x (Chu·∫©n)</option>
                    <option value="1.25">1.25x (Nhanh)</option>
                    <option value="1.50">1.50x (R·∫•t nhanh)</option>
                  </select>
                  <button id="previewVoice" class="icon-btn" style="border-radius:12px; width:auto; padding:0 16px;">üîâ Th·ª≠</button>
             </div>
          </div>
        </div>

        <div class="setup-item" style="grid-column: 1/-1;">
          <h3>‚ú® T·∫°o ƒë·ªÅ b√†i b·∫±ng Gemini AI</h3>
          <div style="display:flex; flex-wrap: wrap; gap:12px; margin-bottom: 16px;">
             <div style="flex: 1; min-width: 200px;">
                <input type="password" id="geminiKey" placeholder="D√°n Gemini API Key v√†o ƒë√¢y..." />
             </div>
             <div style="flex: 2; min-width: 200px; display: flex; gap: 8px;">
                <input type="text" id="geminiTopic" placeholder="Ch·ªß ƒë·ªÅ (VD: C√¥ng ngh·ªá, T√¨nh y√™u, M√πa ƒë√¥ng...)" />
                <button id="aiGenBtn">üöÄ T·∫°o</button>
             </div>
          </div>
          <p style="font-size: 0.85rem; color: var(--text-dim); margin-top: -8px; margin-bottom: 12px;">
             *API Key ch·ªâ d√πng tr·ª±c ti·∫øp tr√™n tr√¨nh duy·ªát c·ªßa b·∫°n, kh√¥ng l∆∞u v·ªÅ server.
          </p>

          <h3>‚úçÔ∏è D·ªØ li·ªáu ƒë·∫ßu v√†o</h3>
          <textarea id="sampleText" rows="4" placeholder="Nh·∫≠p th·ªß c√¥ng ho·∫∑c nh·∫•n 'T·∫°o' ·ªü tr√™n..."></textarea>
        </div>

        <button class="start-btn" id="startBtn">
          <svg style="width:24px;height:24px;fill:currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
          B·∫Øt ƒë·∫ßu luy·ªán t·∫≠p
        </button>
      </div>
    </div>

    <div id="rankPanel" class="tab-content glass-card hidden">
      <h2 style="text-align:center; color:var(--primary); font-family:var(--font-display);">Th√†nh T√≠ch C√° Nh√¢n</h2>
      <div id="personalStats">
        <div class="stats-row" id="personalStatsRow">
          <div class="stat-item"><h4>WPM Max</h4><div class="val" id="personalWPM">0</div></div>
          <div class="stat-item"><h4>Ch√≠nh x√°c</h4><div class="val" id="personalAcc">0%</div></div>
          <div class="stat-item"><h4>S·ªë c√¢u</h4><div class="val" id="personalSentences">0</div></div> 
          <div class="stat-item"><h4>ƒêi·ªÉm cao</h4><div class="val"id="personalScore">0</div></div>
        </div>
        <div style="text-align:center; margin-top:20px;"><span class="level-badge" id="personalBadge">H·∫°ng: T√¢n binh</span></div>
        <div style="margin-top: 40px; padding:20px; background:rgba(255,255,255,0.5); border-radius:20px;">
             <canvas id="personalChart"></canvas>
        </div>
      </div>
    </div>

    <div class="modal" id="loginModal">
      <div class="modal-content">
        <h3>Xin ch√†o! üëã</h3>
        <p style="margin-bottom:20px; color:var(--text-dim);">Nh·∫≠p t√™n ƒë·ªÉ l∆∞u l·∫°i chi·∫øn t√≠ch nh√©.</p>
        <input type="text" id="usernameInput" placeholder="T√™n c·ªßa b·∫°n..." maxlength="20" style="margin-bottom:20px; text-align:center;" />
        <div style="display:flex; gap:10px;">
          <button class="action-btn btn-reset" id="skipLoginBtn" style="flex:1; justify-content:center;">B·ªè qua</button>
          <button class="action-btn btn-next" id="loginBtn" style="flex:1; justify-content:center; background:var(--primary-gradient);">V√†o ngay</button>
        </div>
      </div>
    </div>

    <div id="practiceArea" class="tab-content glass-card hidden">
      <div class="mode-switcher">
        <button class="mode-btn active" data-mode="read-write">Ch√©p</button>
        <button class="mode-btn" data-mode="listen-write">Nghe</button>
        <button class="mode-btn" data-mode="read-listen-write">Nghe-Ch√©p</button>
        <button class="mode-btn" data-mode="read-only">ƒê·ªçc</button>
      </div>

      <div class="progress-box">
        <div style="display:flex; justify-content:space-between; margin-bottom:8px; font-weight:600; font-size:0.9rem;">
          <span>Ti·∫øn tr√¨nh</span> <span id="progressText">0%</span>
        </div>
        <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
      </div>

      <div class="segment-box" id="currentSegment"></div>

      <div class="mic-box hidden" id="micBox">
        <button class="mic-btn" id="micBtn">üé§</button>
        <p style="text-align:center; color:var(--text-dim);">Nh·∫•n mic v√† ƒë·ªçc to ƒëo·∫°n vƒÉn tr√™n</p>
      </div>

      <div id="fullText" style="color:var(--info); font-style:italic; text-align:center; margin-bottom:16px; min-height:24px;"></div>

      <div class="input-wrapper">
        <input type="text" id="userInput" placeholder="G√µ l·∫°i n·ªôi dung ·ªü ƒë√¢y..." autocomplete="off" />
        <button class="hint-btn" id="hintBtn" title="G·ª£i √Ω t·ª´ ti·∫øp theo">?</button>
      </div>

      <div id="liveFeedback" style="text-align:center;"><em>K·∫øt qu·∫£ s·∫Ω hi·ªán ·ªü ƒë√¢y...</em></div>

      <div class="action-row">
        <button class="action-btn btn-replay" id="replayBtn">üîä Nghe l·∫°i</button>
        <button class="action-btn btn-next" id="nextBtn" disabled>Ti·∫øp theo ‚û°Ô∏è</button>
        <button class="action-btn btn-reset" id="resetBtn">Tho√°t</button>
      </div>

      <div class="stats-row">
        <div class="stat-item"><h4>Th·ªùi gian</h4><div class="val" id="time">0s</div></div>
        <div class="stat-item"><h4>T·ªëc ƒë·ªô</h4><div class="val" id="wpm">0</div></div>
        <div class="stat-item"><h4>Ch√≠nh x√°c</h4><div class="val" id="accuracy">100%</div></div>
        <div class="stat-item"><h4>ƒêi·ªÉm</h4><div class="val" id="score">0</div></div>
      </div>
      
      <div style="text-align:center;">
        <div class="level-badge" id="levelBadge" style="margin-top:30px;">C·∫•p ƒë·ªô: M·ªõi b·∫Øt ƒë·∫ßu</div>
        <div id="level" class="hidden"></div> </div>
      <canvas id="mainChart" class="hidden"></canvas>
    </div>

    <footer style="text-align:center; margin-top:40px; color:var(--text-dim); font-size:0.9rem;">
      <p>¬© 2026 HiHi App. Made with ‚ù§Ô∏è & ‚ú®</p>
    </footer>
  </div>

  <script>
    // === 1. H·∫∞NG S·ªê & C·∫§U H√åNH ===
    const coolNicknames = [
      "Chi·∫øn Binh B√†n Ph√≠m", "Vua G√µ Ch·ªØ", "Th·∫ßn T·ªëc", "HiHi Pro", "Ninja Luy·ªán G√µ",
      "Si√™u Anh H√πng G√µ", "Chuy√™n Gia Ch√≠nh T·∫£", "Ng∆∞·ªùi B·∫°n C·ªßa Ch·ªØ", "ƒê√¥i Tay V√†ng"
    ];
    const wordCache = {}; // Cache ƒë·ªÉ l∆∞u t·ª´ ƒë√£ d·ªãch

    // === 2. BI·∫æN TO√ÄN C·ª§C ===
    let typedWords = 0;
    let correctWords = 0;
    let totalCorrectWords = 0;
    let hintsUsed = 0;
    let totalSentences = 0; 
    
    let personalHistory = JSON.parse(localStorage.getItem('personalHistory')) || [];
    let bestStats = JSON.parse(localStorage.getItem('bestStats')) || null;
    let personalChart;
    
    let speechRate = 1.0;
    let currentUtterance = null;
    let currentMode = 'read-write';
    let recognition = null;
    let isListening = false;
    let karaokeWords = [];
    let playerName = '';
    let globalLang = localStorage.getItem('lang') || 'vi-VN';
    let voices = [];
    let selectedVoice = null;
    
    let segments = [];
    let currentIdx = 0;
    let startTime = 0;
    let timer = null;

    // === 3. CH·ªåN PH·∫¶N T·ª¨ (DOM) ===
    const els = {
      lang: document.getElementById('globalLang'),
      text: document.getElementById('sampleText'),
      start: document.getElementById('startBtn'),
      segment: document.getElementById('currentSegment'),
      input: document.getElementById('userInput'),
      feedback: document.getElementById('liveFeedback'),
      fullTrans: document.getElementById('fullText'),
      progressFill: document.getElementById('progressFill'),
      progressText: document.getElementById('progressText'),
      time: document.getElementById('time'),
      wpm: document.getElementById('wpm'),
      acc: document.getElementById('accuracy'),
      level: document.getElementById('level'),
      score: document.getElementById('score'),
      levelBadge: document.getElementById('levelBadge'),
      replay: document.getElementById('replayBtn'),
      hint: document.getElementById('hintBtn'),
      next: document.getElementById('nextBtn'),
      reset: document.getElementById('resetBtn'),
      theme: document.getElementById('themeBtn'),
      holidayBtn: document.getElementById('holidayBtn'), 
      sun: document.getElementById('sunIcon'),
      moon: document.getElementById('moonIcon'),
      voiceSelect: document.getElementById('voiceSelect'),
      voiceRateSelect: document.getElementById('voiceRateSelect'),
      previewVoice: document.getElementById('previewVoice'),
      modeBtns: () => document.querySelectorAll('.mode-btn'),
      micBox: document.getElementById('micBox'),
      micBtn: document.getElementById('micBtn'),
      playerName: document.getElementById('playerName'),
      mainTabs: () => document.querySelectorAll('.tab'),
      tabContents: () => document.querySelectorAll('.tab-content'),
      personalStatsRow: document.getElementById('personalStatsRow'),
      personalWPM: document.getElementById('personalWPM'),
      personalAcc: document.getElementById('personalAcc'),
      personalScore: document.getElementById('personalScore'),
      personalSentences: document.getElementById('personalSentences'),
      personalBadge: document.getElementById('personalBadge'),
      personalChart: document.getElementById('personalChart'),
      loginModal: document.getElementById('loginModal'),
      usernameInput: document.getElementById('usernameInput'),
      loginBtn: document.getElementById('loginBtn'),
      skipLoginBtn: document.getElementById('skipLoginBtn'),
      logoutBtn: document.getElementById('logoutBtn'),
      logoutBtnWrapper: document.getElementById('logoutBtnWrapper'),
      // AI Elements
      geminiKey: document.getElementById('geminiKey'),
      geminiTopic: document.getElementById('geminiTopic'),
      aiGenBtn: document.getElementById('aiGenBtn')
    };

    // === 4. ƒê·ªäNH NGHƒ®A H√ÄM ===

    // === H·ªÜ TH·ªêNG T√ÄI KHO·∫¢N ===
    function handleLogin(name) {
      if (!name) return;
      playerName = name;
      localStorage.setItem('hihiUser', JSON.stringify({ name: playerName }));
      els.playerName.value = playerName;
      els.playerName.readOnly = true;
      els.loginModal.classList.remove('show');
      els.logoutBtnWrapper.classList.remove('hidden');
    }

    function handleLogout() {
      localStorage.removeItem('hihiUser');
      playerName = '';
      els.playerName.value = '';
      els.playerName.readOnly = true;
      els.logoutBtnWrapper.classList.add('hidden');
      els.loginModal.classList.add('show');
      els.usernameInput.value = '';
    }

    function checkLogin() {
      const user = localStorage.getItem('hihiUser');
      if (user) handleLogin(JSON.parse(user).name);
      else els.loginModal.classList.add('show');
    }
    
    // === CH·ª¶ ƒê·ªÄ & GI√ÅNG SINH ===
    function createSnowflakes() {
        const snowContainer = document.getElementById('snowContainer');
        snowContainer.innerHTML = '';
        for (let i = 0; i < 30; i++) {
            const flake = document.createElement('div');
            flake.className = 'snowflake';
            flake.textContent = ['‚ùÑ', '‚ùÖ', '‚ùÜ'][Math.floor(Math.random() * 3)];
            flake.style.left = Math.random() * 100 + 'vw';
            flake.style.animationDuration = Math.random() * 3 + 2 + 's';
            flake.style.fontSize = Math.random() * 10 + 10 + 'px';
            flake.style.opacity = Math.random();
            flake.style.animationDelay = Math.random() * 5 + 's';
            snowContainer.appendChild(flake);
        }
    }

    // --- FIX L·ªñI HOLIDAY: Ch·ªâ k√≠ch ho·∫°t t·ª´ 10/12 ---
    function isHolidaySeason() {
        const now = new Date();
        const month = now.getMonth(); // 0 = Jan, 11 = Dec
        const date = now.getDate();
        const year = now.getFullYear();
        
        // Th√°ng 12 v√† ng√†y >= 10
        if (month === 11 && date >= 10) return true;
        
        // ƒê·∫ßu nƒÉm m·ªõi (Th√°ng 1) v·∫´n c√≤n d∆∞ √¢m
        if (month === 0 && date <= 5) return true;
        
        return false;
    }

    function applyTheme(themeMode) {
        const body = document.body;
        const isDarkPreferred = localStorage.getItem('baseTheme') === 'dark';

        if (themeMode === 'holiday') {
            body.setAttribute('data-theme', isDarkPreferred ? 'holiday-dark' : 'holiday');
        } else {
            body.setAttribute('data-theme', isDarkPreferred ? 'dark' : 'light');
        }

        els.sun.classList.toggle('hidden', !isDarkPreferred);
        els.moon.classList.toggle('hidden', isDarkPreferred);
        
        if (themeMode === 'holiday') createSnowflakes();
        else document.getElementById('snowContainer').innerHTML = '';
    }

    function toggleBaseTheme() {
        const current = localStorage.getItem('baseTheme') === 'dark' ? 'dark' : 'light';
        const next = current === 'dark' ? 'light' : 'dark';
        localStorage.setItem('baseTheme', next);
        
        const isHolidayOn = localStorage.getItem('isHoliday') === 'true';
        applyTheme(isHolidayOn ? 'holiday' : next);
    }

    function toggleHolidayMode() {
        const isCurrentlyOn = localStorage.getItem('isHoliday') === 'true';
        const nextState = !isCurrentlyOn;
        localStorage.setItem('isHoliday', nextState);
        
        const base = localStorage.getItem('baseTheme') || 'light';
        applyTheme(nextState ? 'holiday' : base);
    }

    function initTheme() {
        if (!localStorage.getItem('baseTheme')) localStorage.setItem('baseTheme', 'light');

        // Logic t·ª± ƒë·ªông k√≠ch ho·∫°t d·ª±a tr√™n ng√†y th√°ng
        if (isHolidaySeason()) {
            if (localStorage.getItem('autoHolidaySet') !== 'true') {
                localStorage.setItem('isHoliday', 'true');
                localStorage.setItem('autoHolidaySet', 'true');
            }
        } else {
            // N·∫øu ch∆∞a ƒë·∫øn ng√†y, reset flag t·ª± ƒë·ªông ƒë·ªÉ sang nƒÉm n√≥ l·∫°i ch·∫°y
             localStorage.removeItem('autoHolidaySet');
        }
        
        const isHoliday = localStorage.getItem('isHoliday') === 'true';
        const base = localStorage.getItem('baseTheme');
        applyTheme(isHoliday ? 'holiday' : base);
    }

    // === GEMINI AI INTEGRATION ===
    els.aiGenBtn.addEventListener('click', async () => {
        const key = els.geminiKey.value.trim();
        const topic = els.geminiTopic.value.trim() || "ch·ªß ƒë·ªÅ ng·∫´u nhi√™n, th√∫ v·ªã";
        const lang = els.lang.value;
        
        if (!key) {
            alert("Vui l√≤ng nh·∫≠p Gemini API Key! (B·∫°n c√≥ th·ªÉ l·∫•y mi·ªÖn ph√≠ t·∫°i aistudio.google.com)");
            return;
        }

        els.aiGenBtn.textContent = "‚è≥ ƒêang vi·∫øt...";
        els.aiGenBtn.disabled = true;
        els.text.value = "ƒêang k·∫øt n·ªëi v·ªõi Gemini AI...";

        let prompt = "";
        if (lang.startsWith('vi')) {
            prompt = `H√£y vi·∫øt m·ªôt ƒëo·∫°n vƒÉn ng·∫Øn kho·∫£ng 100-150 t·ª´ v·ªÅ ch·ªß ƒë·ªÅ "${topic}" ƒë·ªÉ d√πng cho vi·ªác luy·ªán g√µ ph√≠m (typing practice). VƒÉn b·∫£n c·∫ßn chu·∫©n ch√≠nh t·∫£, ng·ªØ ph√°p, d·∫•u c√¢u, gi·ªçng vƒÉn t·ª± nhi√™n. Ch·ªâ tr·∫£ v·ªÅ n·ªôi dung vƒÉn b·∫£n, kh√¥ng k√®m ti√™u ƒë·ªÅ hay l·ªùi d·∫´n.`;
        } else if (lang.startsWith('en')) {
            prompt = `Write a short paragraph (approx 100-150 words) about "${topic}" for typing practice. Ensure correct grammar and punctuation. Return only the text content, no markdown, no title.`;
        } else if (lang.startsWith('id')) {
            prompt = `Buatlah paragraf pendek (sekitar 100-150 kata) tentang "${topic}" untuk latihan mengetik. Pastikan tata bahasa benar. Kembalikan hanya isi teks saja.`;
        }

        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${key}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }]
                })
            });

            const data = await response.json();
            
            if (data.error) {
                throw new Error(data.error.message);
            }

            const generatedText = data.candidates[0].content.parts[0].text;
            els.text.value = generatedText.trim();
        } catch (error) {
            alert("L·ªói khi g·ªçi AI: " + error.message);
            els.text.value = "";
        } finally {
            els.aiGenBtn.textContent = "üöÄ T·∫°o";
            els.aiGenBtn.disabled = false;
        }
    });


    // === TABS ===
    function setupTabs(tabButtons, tabContents) {
        tabButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                const targetId = btn.dataset.tab;
                tabButtons.forEach(t => t.classList.remove('active'));
                btn.classList.add('active');
                tabContents.forEach(c => c.classList.toggle('hidden', c.id !== targetId));
                
                if (btn.dataset.tab === 'rankPanel') renderPersonalStats();
            });
        });
    }

    function renderPersonalStats() {
      if (bestStats) {
        els.personalWPM.textContent = bestStats.wpm;
        els.personalAcc.textContent = bestStats.acc + '%';
        els.personalScore.textContent = bestStats.score;
        els.personalSentences.textContent = bestStats.sentences || 0;
        els.personalBadge.textContent = bestStats.badge;
      }
      
      const ctx = els.personalChart.getContext('2d');
      if (personalChart) personalChart.destroy();
      const recentHistory = [...personalHistory].reverse();
      
      personalChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: recentHistory.map((_,i) => `L·∫ßn ${i+1}`),
          datasets: [
            { label: 'WPM', data: recentHistory.map(h=>h.wpm), borderColor: '#8b5cf6', tension: 0.4, fill: true, backgroundColor: 'rgba(139, 92, 246, 0.2)' },
            { label: 'ƒêi·ªÉm', data: recentHistory.map(h=>h.score), borderColor: '#ec4899', tension: 0.4 }
          ]
        },
        options: { responsive: true, plugins: { legend: { position: 'top
