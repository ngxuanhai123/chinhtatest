<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>HiHi - Luy·ªán Ch√≠nh T·∫£ Th√¥ng Minh (Ultimate AI Edition)</title>
  <meta name="description" content="Luy·ªán g√µ chu·∫©n, nghe r√µ, ƒë·ªçc to ‚Äì nh·∫≠n di·ªán gi·ªçng n√≥i, karaoke. T√≠ch h·ª£p AI Gemini 1.5 Flash.">
  <meta name="theme-color" content="#8b5cf6">
  <link href="https://googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700;800&family=Outfit:wght@400;600;800&family=Mountains+of+Christmas:wght@700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  
  <style>
    :root {
      /* --- M√ÄU S·∫ÆC & BI·∫æN --- */
      --bg-color: #0f172a;
      --glass-surface: rgba(255, 255, 255, 0.75);
      --glass-border: rgba(255, 255, 255, 0.4);
      --glass-blur: 20px;
      --text: #1e293b; 
      --text-dim: #64748b;
      
      --primary-gradient: linear-gradient(135deg, #8b5cf6 0%, #ec4899 100%);
      --primary-shadow: rgba(139, 92, 246, 0.4);
      --primary: #8b5cf6;
      
      --success: #10b981; --danger: #ef4444; --warning: #f59e0b; --info: #3b82f6;
      --card-radius: 24px; --input-radius: 16px; --btn-radius: 16px;
      --font-main: 'Be Vietnam Pro', sans-serif;
      --font-display: 'Outfit', sans-serif;
      --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.05);
      --shadow-glow: 0 0 20px rgba(139, 92, 246, 0.3);
    }

    /* DARK MODE */
    [data-theme="dark"] {
      --bg-color: #020617;
      --glass-surface: rgba(15, 23, 42, 0.65);
      --glass-border: rgba(255, 255, 255, 0.08);
      --text: #f8fafc;
      --text-dim: #94a3b8;
      --shadow-lg: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    }

    /* HOLIDAY MODE */
    [data-theme*="holiday"] {
      --primary-gradient: linear-gradient(135deg, #dc2626 0%, #16a34a 100%);
      --primary-shadow: rgba(220, 38, 38, 0.4);
      --primary: #dc2626;
      --bg-color: #0f2b1d;
      --font-display: 'Mountains of Christmas', cursive;
    }
    [data-theme="holiday"] { --glass-surface: rgba(255, 255, 255, 0.85); }
    [data-theme="holiday-dark"] {
      --glass-surface: rgba(20, 10, 10, 0.75);
      --text: #ffe4e6;
      --bg-color: #1a0505;
    }

    /* --- RESET & BASE --- */
    * { margin:0; padding:0; box-sizing:border-box; -webkit-font-smoothing: antialiased; }
    body {
      font-family: var(--font-main); background-color: var(--bg-color); color: var(--text);
      min-height: 100vh; padding: 20px; line-height: 1.6; overflow-x: hidden;
      transition: background-color 0.5s ease, color 0.3s ease;
    }

    /* ANIMATED BACKGROUND */
    .aurora-bg { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: -1; overflow: hidden; pointer-events: none; }
    .aurora-blob { position: absolute; filter: blur(80px); opacity: 0.6; animation: floatBlob 20s infinite alternate cubic-bezier(0.4, 0, 0.2, 1); }
    .blob-1 { top: -10%; left: -10%; width: 50vw; height: 50vw; background: #8b5cf6; }
    .blob-2 { bottom: -10%; right: -10%; width: 60vw; height: 60vw; background: #ec4899; animation-delay: -5s; }
    .blob-3 { top: 40%; left: 40%; width: 40vw; height: 40vw; background: #3b82f6; animation-delay: -10s; }
    [data-theme*="holiday"] .blob-1 { background: #dc2626; }
    [data-theme*="holiday"] .blob-2 { background: #16a34a; }
    [data-theme*="holiday"] .blob-3 { background: #fbbf24; }
    @keyframes floatBlob { 0% { transform: translate(0, 0) scale(1); } 100% { transform: translate(20px, 40px) scale(1.1); } }

    /* SNOWFLAKES */
    .snowflake {
      position: fixed; top: -10px; z-index: 999; color: #fff; 
      text-shadow: 0 0 5px rgba(255,255,255,0.8); pointer-events: none;
      animation: fall linear forwards; display: none;
    }
    [data-theme*="holiday"] .snowflake { display: block; }
    @keyframes fall { to { transform: translateY(105vh) rotate(360deg); } }

    /* CONTAINER & CARD */
    .container { max-width: 1100px; margin: 0 auto; display: flex; flex-direction: column; gap: 32px; position: relative; z-index: 10; padding-top: 40px; }
    .glass-card {
      background: var(--glass-surface); backdrop-filter: blur(var(--glass-blur));
      -webkit-backdrop-filter: blur(var(--glass-blur));
      border: 1px solid var(--glass-border); border-radius: var(--card-radius);
      box-shadow: var(--shadow-lg); transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    /* HEADER */
    header { padding: 40px 30px; text-align: center; position: relative; overflow: hidden; }
    header::before { content: ''; position: absolute; top:0; left:0; right:0; height: 6px; background: var(--primary-gradient); }
    .logo { display: flex; align-items: center; justify-content: center; gap: 12px; margin-bottom: 8px; }
    .logo svg { width: 50px; height: 50px; fill: url(#grad1); animation: floatLogo 6s ease-in-out infinite; }
    .logo h1 { font-family: var(--font-display); font-size: 3.5rem; font-weight: 800; background: var(--primary-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; line-height: 1.1; }
    @keyframes floatLogo { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-8px) rotate(2deg)} }

    /* CONTROLS & BUTTONS */
    .theme-toggle-wrapper { position: absolute; top: 20px; right: 20px; display: flex; gap: 12px; }
    .icon-btn {
      width: 44px; height: 44px; border-radius: 50%; border: none; background: var(--glass-surface); color: var(--text);
      border: 1px solid var(--glass-border); cursor: pointer; display: flex; align-items: center; justify-content: center;
      transition: 0.3s; box-shadow: var(--shadow-sm); font-size: 1.2rem;
    }
    .icon-btn:hover { transform: scale(1.1); background: var(--text); color: var(--bg-color); }
    #logoutBtn { color: var(--danger); }
    #logoutBtn:hover { background: var(--danger); color: white; }

    /* TABS */
    .tabs { display: inline-flex; background: var(--glass-surface); padding: 6px; border-radius: 20px; border: 1px solid var(--glass-border); margin: 0 auto; }
    .tab { padding: 12px 32px; border-radius: 14px; border: none; background: transparent; color: var(--text-dim); font-weight: 600; cursor: pointer; transition: 0.3s; }
    .tab.active { background: var(--primary-gradient); color: white; box-shadow: 0 4px 12px var(--primary-shadow); }

    /* INPUTS & SETUP */
    .name-box input { background: transparent; border: none; border-bottom: 2px solid var(--glass-border); text-align: center; font-size: 1.2rem; color: var(--text); font-weight: 700; width: 300px; padding: 8px; }
    .setup-grid { padding: 40px; display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 24px; }
    .setup-item { background: rgba(255,255,255,0.05); border-radius: var(--input-radius); padding: 24px; border: 1px solid var(--glass-border); }
    .setup-item h3 { font-size: 1.1rem; margin-bottom: 16px; color: var(--primary); display: flex; align-items: center; gap: 8px; font-weight: 700; }
    
    select, textarea, input[type="text"] { width: 100%; padding: 14px 16px; border: 2px solid var(--glass-border); border-radius: var(--input-radius); background: rgba(255,255,255,0.5); color: #0f172a; font-family: var(--font-main); transition: 0.3s; }
    [data-theme="dark"] select, [data-theme="dark"] textarea, [data-theme="dark"] input[type="text"] { background: rgba(0,0,0,0.3); color: #fff; border-color: rgba(255,255,255,0.1); }

    /* RADIO BUTTONS */
    .radio-group { display: flex; flex-direction: column; gap: 10px; }
    .radio-label { display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 12px; cursor: pointer; border: 1px solid transparent; }
    .radio-label:has(input:checked) { background: rgba(139, 92, 246, 0.15); border-color: var(--primary); font-weight: 600; }

    /* MAIN START BUTTON */
    .start-btn {
      grid-column: 1/-1; margin-top: 10px; padding: 20px; background: var(--primary-gradient); color: white;
      font-weight: 700; font-size: 1.25rem; border: none; border-radius: var(--btn-radius); cursor: pointer;
      display: flex; align-items: center; justify-content: center; gap: 10px; box-shadow: 0 10px 20px var(--primary-shadow);
      transition: transform 0.3s; text-transform: uppercase; letter-spacing: 1px;
    }
    .start-btn:hover { transform: translateY(-4px) scale(1.02); }

    /* PRACTICE AREA */
    .mode-switcher { display: flex; justify-content: center; gap: 8px; margin-bottom: 24px; }
    .mode-btn { padding: 8px 20px; border-radius: 30px; border: 1px solid var(--glass-border); background: transparent; color: var(--text); font-weight: 600; cursor: pointer; }
    .mode-btn.active { background: var(--text); color: var(--bg-color); border-color: transparent; }

    .segment-box {
      font-size: 1.6rem; line-height: 1.8; text-align: center; min-height: 160px; padding: 40px;
      background: rgba(255,255,255,0.5); border-radius: 20px; border: 2px dashed var(--primary); margin-bottom: 24px;
      color: var(--text); font-weight: 600; display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 8px;
    }
    [data-theme="dark"] .segment-box { background: rgba(0,0,0,0.2); border-color: var(--text-dim); }

    /* KARAOKE & FEEDBACK */
    .karaoke-word { padding: 4px 8px; border-radius: 8px; transition: 0.2s; position: relative; }
    .karaoke-active { background: var(--primary); color: white !important; transform: scale(1.1); box-shadow: 0 4px 12px var(--primary-shadow); z-index: 10; }
    .word-tooltip {
        position: absolute; bottom: 110%; left: 50%; transform: translateX(-50%); background: #1e293b; color: white;
        padding: 4px 8px; border-radius: 6px; font-size: 0.8rem; opacity: 0; pointer-events: none; white-space: nowrap; transition: 0.2s;
    }
    .karaoke-word:hover .word-tooltip { opacity: 1; transform: translateX(-50%) translateY(-5px); }

    .input-wrapper { position: relative; margin: 30px 0; }
    #userInput { font-size: 1.5rem; padding: 20px 60px 20px 24px; border-radius: 24px; box-shadow: var(--shadow-sm); }
    .hint-btn {
      position: absolute; right: 16px; top: 50%; transform: translateY(-50%); width: 40px; height: 40px;
      border-radius: 12px; background: #8b5cf6; color: white; border: none; cursor: pointer;
    }
    .correct { color: var(--success); font-weight: 700; }
    .wrong { color: var(--danger); text-decoration: line-through; opacity: 0.7; }

    /* STATS & BADGES */
    .stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-top: 40px; }
    .stat-item { background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); padding: 16px; border-radius: 16px; text-align: center; }
    .stat-item .val { font-size: 1.8rem; font-weight: 800; color: var(--primary); font-family: var(--font-display); }
    .level-badge { display: inline-block; padding: 8px 24px; border-radius: 30px; background: var(--primary-gradient); color: white; font-weight: 700; margin-top: 20px; }

    /* MODAL (LOGIN) - Fixed Z-Index */
    .modal {
      position: fixed; top:0; left:0; width:100%; height:100%; z-index: 10000;
      background: rgba(0,0,0,0.7); backdrop-filter: blur(8px);
      display: flex; align-items: center; justify-content: center;
      opacity: 0; visibility: hidden; transition: 0.3s;
    }
    .modal.show { opacity: 1; visibility: visible; }
    .modal-content { background: var(--bg-color); border: 1px solid var(--glass-border); padding: 40px; border-radius: 32px; width: 90%; max-width: 450px; text-align: center; }

    /* MIC BUTTON */
    .mic-btn {
      width: 70px; height: 70px; border-radius: 50%; background: var(--danger); color: white;
      font-size: 2rem; border: none; cursor: pointer; margin: 0 auto 20px; display: block; transition: 0.3s;
    }
    .mic-btn.listening { background: var(--success); animation: pulseMic 1.5s infinite; }
    @keyframes pulseMic { 0% { box-shadow: 0 0 0 0 rgba(16,185,129,0.7); } 70% { box-shadow: 0 0 0 20px transparent; } 100% { box-shadow: 0 0 0 0 transparent; } }

    /* AI LOADING */
    .ai-loading {
      background: linear-gradient(to right, rgba(255,255,255,0.1) 8%, rgba(255,255,255,0.2) 18%, rgba(255,255,255,0.1) 33%);
      background-size: 1000px 100%; animation: shimmer 1.5s infinite linear; opacity: 0.7; pointer-events: none;
    }
    @keyframes shimmer { 0% { background-position: -1000px 0; } 100% { background-position: 1000px 0; } }

    /* UTILS */
    .hidden { display: none !important; }
    .action-btn { padding: 16px 32px; border-radius: 16px; border: none; font-weight: 700; cursor: pointer; color: white; transition: 0.3s; }
    .btn-next { background: var(--success); }
    .btn-reset { background: var(--glass-surface); color: var(--text); border: 1px solid var(--glass-border); }
    .btn-replay { background: var(--warning); }

    @media (max-width: 768px) {
      .logo h1 { font-size: 2.5rem; }
      .stats-row { grid-template-columns: 1fr 1fr; }
      .setup-grid { grid-template-columns: 1fr; padding: 24px; }
    }
    .svg-defs { width: 0; height: 0; position: absolute; }
  </style>
</head>
<body>

  <div class="aurora-bg">
    <div class="aurora-blob blob-1"></div>
    <div class="aurora-blob blob-2"></div>
    <div class="aurora-blob blob-3"></div>
  </div>
  <div id="snowContainer"></div>

  <svg class="svg-defs">
    <defs>
      <linearGradient id="grad1" x1="0%" y1="0%" x2="100%" y2="0%">
        <stop offset="0%" style="stop-color:#8b5cf6;stop-opacity:1" />
        <stop offset="100%" style="stop-color:#ec4899;stop-opacity:1" />
      </linearGradient>
    </defs>
  </svg>

  <div class="container">
    <header class="glass-card">
      <div class="theme-toggle-wrapper">
        <button class="icon-btn" id="holidayBtn" title="Ch·∫ø ƒë·ªô Gi√°ng Sinh">üéÑ</button>
        <button class="icon-btn" id="themeBtn" title="ƒê·ªïi giao di·ªán S√°ng/T·ªëi">
           <span id="sunIcon">‚òÄÔ∏è</span><span id="moonIcon" class="hidden">üåô</span>
        </button>
        <div id="logoutBtnWrapper" class="hidden">
            <button class="icon-btn" id="logoutBtn" title="ƒêƒÉng xu·∫•t">üö™</button>
        </div>
      </div>

      <div class="logo">
        <svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h14l4 4V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/></svg>
        <h1>HiHi<span style="font-size:0.4em; vertical-align: super; opacity: 0.8;">AI</span></h1>
      </div>
      <p class="tagline">Luy·ªán ch√≠nh t·∫£ & ngo·∫°i ng·ªØ phong c√°ch m·ªõi üöÄ</p>
    </header>

    <div class="tabs">
      <button class="tab active" data-tab="setupPanel">Luy·ªán T·∫≠p</button>
      <button class="tab" data-tab="rankPanel">Th·ªëng K√™</button>
    </div>

    <div class="name-box" style="text-align:center;">
      <input type="text" id="playerName" placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n..." maxlength="20" readonly />
    </div>

    <div id="setupPanel" class="tab-content glass-card">
      <div class="setup-grid">
        <div class="setup-item">
          <h3>üåç Ng√¥n ng·ªØ</h3>
          <select id="globalLang">
            <option value="vi-VN">Ti·∫øng Vi·ªát (G·ªëc)</option>
            <option value="en-US">Ti·∫øng Anh ‚Üí Vi·ªát</option>
            <option value="id-ID">Ti·∫øng Indonesia ‚Üí Vi·ªát</option>
          </select>
        </div>

        <div class="setup-item">
          <h3>üéÆ Ch·∫ø ƒë·ªô ch∆°i</h3>
          <div class="radio-group">
            <label class="radio-label"><input type="radio" name="mode" value="read-write" checked> <span>Nh√¨n & Ch√©p</span></label>
            <label class="radio-label"><input type="radio" name="mode" value="listen-write"> <span>Nghe & Ch√©p</span></label>
            <label class="radio-label"><input type="radio" name="mode" value="read-listen-write"> <span>Nghe - Nh√¨n - Ch√©p</span></label>
            <label class="radio-label"><input type="radio" name="mode" value="read-only"> <span>Luy·ªán ƒê·ªçc (Mic)</span></label>
          </div>
        </div>
        
        <div class="setup-item">
          <h3>üîä Gi·ªçng ƒë·ªçc</h3>
          <div style="display:flex; flex-direction:column; gap:12px;">
             <select id="voiceSelect"></select>
             <div style="display:flex; gap:10px;">
                 <select id="voiceRateSelect" style="flex:1;">
                    <option value="0.75">0.75x (Ch·∫≠m)</option>
                    <option value="1.00" selected>1.00x (Chu·∫©n)</option>
                    <option value="1.25">1.25x (Nhanh)</option>
                  </select>
                  <button id="previewVoice" class="icon-btn" style="border-radius:12px; width:auto; padding:0 16px;">üîâ Th·ª≠</button>
             </div>
          </div>
        </div>

        <div class="setup-item" style="grid-column: 1/-1;">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
             <h3>‚úçÔ∏è D·ªØ li·ªáu ƒë·∫ßu v√†o</h3>
             <div style="display:flex; gap:10px;">
                 <button id="aiKeyResetBtn" class="icon-btn" title="X√≥a API Key" style="width:36px; height:36px; font-size:0.9rem; background:#ef4444; color:white; border:none; border-radius:8px;">üîë</button>
                 <button id="aiGenerateBtn" class="icon-btn" style="width:auto; padding:0 15px; font-size:0.9rem; border-radius:12px; background:var(--primary-gradient); color:white; border:none; font-weight:600;">
                   ‚ú® AI Vi·∫øt B√†i
                 </button>
             </div>
          </div>
          <textarea id="sampleText" rows="4" placeholder="D√°n ƒëo·∫°n vƒÉn b·∫°n mu·ªën luy·ªán ho·∫∑c nh·∫•n n√∫t AI..."></textarea>
        </div>

        <button class="start-btn" id="startBtn">
          B·∫Øt ƒë·∫ßu luy·ªán t·∫≠p
        </button>
      </div>
    </div>

    <div id="rankPanel" class="tab-content glass-card hidden">
      <h2 style="text-align:center; color:var(--primary); font-family:var(--font-display);">Th√†nh T√≠ch C√° Nh√¢n</h2>
      <div id="personalStats">
        <div class="stats-row" id="personalStatsRow">
          <div class="stat-item"><h4>WPM Max</h4><div class="val" id="personalWPM">0</div></div>
          <div class="stat-item"><h4>Ch√≠nh x√°c</h4><div class="val" id="personalAcc">0%</div></div>
          <div class="stat-item"><h4>S·ªë c√¢u</h4><div class="val" id="personalSentences">0</div></div> 
          <div class="stat-item"><h4>ƒêi·ªÉm cao</h4><div class="val" id="personalScore">0</div></div>
        </div>
        <div style="text-align:center; margin-top:20px;"><span class="level-badge" id="personalBadge">H·∫°ng: T√¢n binh</span></div>
        <div style="margin-top: 40px; padding:20px; background:rgba(255,255,255,0.5); border-radius:20px;">
             <canvas id="personalChart"></canvas>
        </div>
      </div>
    </div>

    <div class="modal" id="loginModal">
      <div class="modal-content">
        <h3>Xin ch√†o! üëã</h3>
        <p style="margin-bottom:20px; color:var(--text-dim);">Nh·∫≠p t√™n ƒë·ªÉ l∆∞u l·∫°i chi·∫øn t√≠ch nh√©.</p>
        <input type="text" id="usernameInput" placeholder="T√™n c·ªßa b·∫°n..." maxlength="20" style="margin-bottom:20px; text-align:center;" />
        <div style="display:flex; gap:10px;">
          <button class="action-btn btn-reset" id="skipLoginBtn" style="flex:1; justify-content:center;">B·ªè qua</button>
          <button class="action-btn btn-next" id="loginBtn" style="flex:1; justify-content:center; background:var(--primary-gradient);">V√†o ngay</button>
        </div>
      </div>
    </div>

    <div id="practiceArea" class="tab-content glass-card hidden">
      <div class="mode-switcher">
        <button class="mode-btn active" data-mode="read-write">Ch√©p</button>
        <button class="mode-btn" data-mode="listen-write">Nghe</button>
        <button class="mode-btn" data-mode="read-listen-write">Nghe-Ch√©p</button>
        <button class="mode-btn" data-mode="read-only">ƒê·ªçc</button>
      </div>

      <div style="margin-bottom:20px;">
        <div style="display:flex; justify-content:space-between; margin-bottom:8px; font-weight:600; font-size:0.9rem;">
          <span>Ti·∫øn tr√¨nh</span> <span id="progressText">0%</span>
        </div>
        <div style="height:12px; background:rgba(0,0,0,0.1); border-radius:10px; overflow:hidden;">
            <div style="height:100%; background:var(--primary-gradient); width:0; border-radius:10px; transition:width 0.5s ease;" id="progressFill"></div>
        </div>
      </div>

      <div class="segment-box" id="currentSegment"></div>

      <div class="mic-box hidden" id="micBox">
        <button class="mic-btn" id="micBtn">üé§</button>
        <p style="text-align:center; color:var(--text-dim);">Nh·∫•n mic v√† ƒë·ªçc to ƒëo·∫°n vƒÉn tr√™n</p>
      </div>

      <div id="fullText" style="color:var(--info); font-style:italic; text-align:center; margin-bottom:16px; min-height:24px;"></div>

      <div class="input-wrapper">
        <input type="text" id="userInput" placeholder="G√µ l·∫°i n·ªôi dung ·ªü ƒë√¢y..." autocomplete="off" />
        <button class="hint-btn" id="hintBtn" title="G·ª£i √Ω t·ª´ ti·∫øp theo">?</button>
      </div>

      <div id="liveFeedback" style="text-align:center; font-family:monospace; min-height:30px;"><em>K·∫øt qu·∫£ s·∫Ω hi·ªán ·ªü ƒë√¢y...</em></div>

      <div style="display:flex; justify-content:center; gap:16px; flex-wrap:wrap; margin-top:30px;">
        <button class="action-btn btn-replay" id="replayBtn">üîä Nghe l·∫°i</button>
        <button class="action-btn btn-next" id="nextBtn" disabled>Ti·∫øp theo ‚û°Ô∏è</button>
        <button class="action-btn btn-reset" id="resetBtn">Tho√°t</button>
      </div>

      <div class="stats-row">
        <div class="stat-item"><h4>Th·ªùi gian</h4><div class="val" id="time">0s</div></div>
        <div class="stat-item"><h4>T·ªëc ƒë·ªô</h4><div class="val" id="wpm">0</div></div>
        <div class="stat-item"><h4>Ch√≠nh x√°c</h4><div class="val" id="accuracy">100%</div></div>
        <div class="stat-item"><h4>ƒêi·ªÉm</h4><div class="val" id="score">0</div></div>
      </div>
      
      <div style="text-align:center;">
        <div class="level-badge" id="levelBadge" style="margin-top:30px;">C·∫•p ƒë·ªô: M·ªõi b·∫Øt ƒë·∫ßu</div>
      </div>
    </div>

    <footer style="text-align:center; margin-top:40px; color:var(--text-dim); font-size:0.9rem;">
      <p>¬© 2026 HiHi App. Fixed & Enhanced Edition.</p>
    </footer>
  </div>

  <script>
    // === 1. BI·∫æN & C·∫§U H√åNH ===
    const coolNicknames = ["Chi·∫øn Binh", "Vua G√µ Ch·ªØ", "Th·∫ßn T·ªëc", "HiHi Pro", "Ninja", "Si√™u Nh√¢n"];
    const wordCache = {}; 

    let typedWords = 0, correctWords = 0, totalCorrectWords = 0, hintsUsed = 0, totalSentences = 0; 
    let personalHistory = JSON.parse(localStorage.getItem('personalHistory')) || [];
    let bestStats = JSON.parse(localStorage.getItem('bestStats')) || null;
    let personalChart;
    
    let speechRate = 1.0;
    let currentUtterance = null;
    let currentMode = 'read-write';
    let recognition = null;
    let isListening = false;
    let karaokeWords = [];
    let playerName = '';
    let globalLang = localStorage.getItem('lang') || 'vi-VN';
    let voices = [];
    let selectedVoice = null;
    let segments = [];
    let currentIdx = 0;
    let startTime = 0;
    let timer = null;

    // === 2. DOM ELEMENTS ===
    const els = {
      lang: document.getElementById('globalLang'),
      text: document.getElementById('sampleText'),
      start: document.getElementById('startBtn'),
      segment: document.getElementById('currentSegment'),
      input: document.getElementById('userInput'),
      feedback: document.getElementById('liveFeedback'),
      fullTrans: document.getElementById('fullText'),
      progressFill: document.getElementById('progressFill'),
      progressText: document.getElementById('progressText'),
      time: document.getElementById('time'),
      wpm: document.getElementById('wpm'),
      acc: document.getElementById('accuracy'),
      score: document.getElementById('score'),
      levelBadge: document.getElementById('levelBadge'),
      replay: document.getElementById('replayBtn'),
      hint: document.getElementById('hintBtn'),
      next: document.getElementById('nextBtn'),
      reset: document.getElementById('resetBtn'),
      theme: document.getElementById('themeBtn'),
      holidayBtn: document.getElementById('holidayBtn'), 
      sun: document.getElementById('sunIcon'),
      moon: document.getElementById('moonIcon'),
      voiceSelect: document.getElementById('voiceSelect'),
      voiceRateSelect: document.getElementById('voiceRateSelect'),
      previewVoice: document.getElementById('previewVoice'),
      modeBtns: () => document.querySelectorAll('.mode-btn'),
      micBox: document.getElementById('micBox'),
      micBtn: document.getElementById('micBtn'),
      playerName: document.getElementById('playerName'),
      mainTabs: () => document.querySelectorAll('.tab'),
      tabContents: () => document.querySelectorAll('.tab-content'),
      personalStatsRow: document.getElementById('personalStatsRow'),
      personalWPM: document.getElementById('personalWPM'),
      personalAcc: document.getElementById('personalAcc'),
      personalScore: document.getElementById('personalScore'),
      personalSentences: document.getElementById('personalSentences'),
      personalBadge: document.getElementById('personalBadge'),
      personalChart: document.getElementById('personalChart'),
      loginModal: document.getElementById('loginModal'),
      usernameInput: document.getElementById('usernameInput'),
      loginBtn: document.getElementById('loginBtn'),
      skipLoginBtn: document.getElementById('skipLoginBtn'),
      logoutBtn: document.getElementById('logoutBtn'),
      logoutBtnWrapper: document.getElementById('logoutBtnWrapper'),
      aiBtn: document.getElementById('aiGenerateBtn'),
      aiResetBtn: document.getElementById('aiKeyResetBtn')
    };

    // === 3. H·ªÜ TH·ªêNG T√ÄI KHO·∫¢N (ƒê√£ fix l·ªói) ===
    function handleLogin(name) {
      if (!name) return;
      playerName = name;
      localStorage.setItem('hihiUser', JSON.stringify({ name: playerName }));
      els.playerName.value = playerName;
      els.loginModal.classList.remove('show');
      els.logoutBtnWrapper.classList.remove('hidden');
    }

    function handleLogout() {
      localStorage.removeItem('hihiUser');
      playerName = '';
      els.playerName.value = '';
      els.logoutBtnWrapper.classList.add('hidden');
      els.loginModal.classList.add('show');
      els.usernameInput.value = '';
    }

    function checkLogin() {
      try {
          const user = localStorage.getItem('hihiUser');
          if (user) {
              const parsed = JSON.parse(user);
              if (parsed && parsed.name) {
                  handleLogin(parsed.name);
                  return;
              }
          }
      } catch (e) {
          localStorage.removeItem('hihiUser');
      }
      els.loginModal.classList.add('show');
    }

    // === 4. THEMES ===
    function createSnowflakes() {
        const snowContainer = document.getElementById('snowContainer');
        snowContainer.innerHTML = '';
        for (let i = 0; i < 30; i++) {
            const flake = document.createElement('div');
            flake.className = 'snowflake';
            flake.textContent = ['‚ùÑ', '‚ùÖ', '‚ùÜ'][Math.floor(Math.random() * 3)];
            flake.style.left = Math.random() * 100 + 'vw';
            flake.style.animationDuration = Math.random() * 3 + 2 + 's';
            flake.style.fontSize = Math.random() * 10 + 10 + 'px';
            flake.style.opacity = Math.random();
            flake.style.animationDelay = Math.random() * 5 + 's';
            snowContainer.appendChild(flake);
        }
    }

    function applyTheme(themeMode) {
        const body = document.body;
        const isDarkPreferred = localStorage.getItem('baseTheme') === 'dark';
        
        if (themeMode === 'holiday') {
            body.setAttribute('data-theme', isDarkPreferred ? 'holiday-dark' : 'holiday');
            createSnowflakes();
        } else {
            body.setAttribute('data-theme', isDarkPreferred ? 'dark' : 'light');
            document.getElementById('snowContainer').innerHTML = '';
        }
        
        els.sun.classList.toggle('hidden', !isDarkPreferred);
        els.moon.classList.toggle('hidden', isDarkPreferred);
    }

    function toggleBaseTheme() {
        const current = localStorage.getItem('baseTheme') === 'dark' ? 'dark' : 'light';
        const next = current === 'dark' ? 'light' : 'dark';
        localStorage.setItem('baseTheme', next);
        const isHolidayOn = localStorage.getItem('isHoliday') === 'true';
        applyTheme(isHolidayOn ? 'holiday' : next);
    }

    function toggleHolidayMode() {
        const isCurrentlyOn = localStorage.getItem('isHoliday') === 'true';
        localStorage.setItem('isHoliday', !isCurrentlyOn);
        applyTheme(!isCurrentlyOn ? 'holiday' : (localStorage.getItem('baseTheme') || 'light'));
    }

    // === 5. AI GEMINI (FIXED & UPDATED MODEL) ===
    async function handleAIGeneration() {
        let apiKey = localStorage.getItem('geminiKey');
        
        if (!apiKey) {
            apiKey = prompt("Nh·∫≠p Google API Key c·ªßa b·∫°n (L·∫•y mi·ªÖn ph√≠ t·∫°i aistudio.google.com):");
            if (apiKey && apiKey.trim()) localStorage.setItem('geminiKey', apiKey.trim());
            else return;
        }

        const topic = prompt("Ch·ªß ƒë·ªÅ b√†i vi·∫øt:", "Truy·ªán c∆∞·ªùi ng·∫Øn");
        if (!topic) return;

        const originalText = els.aiBtn.innerHTML;
        els.aiBtn.innerHTML = "‚è≥ ƒêang vi·∫øt...";
        els.aiBtn.disabled = true;
        els.text.classList.add('ai-loading');

        try {
            // D√πng Model 1.5 Flash m·ªõi nh·∫•t
            const langInstruction = globalLang === 'vi-VN' ? 'b·∫±ng Ti·∫øng Vi·ªát' : 'in English';
            const promptText = `Write a paragraph (about 4-5 sentences) about: "${topic}" ${langInstruction}. Plain text only.`;

            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: promptText }] }] })
            });

            if (!response.ok) {
                const errData = await response.json();
                const errMsg = errData.error ? errData.error.message : response.statusText;
                
                // T·ª± ƒë·ªông x√≥a Key n·∫øu sai/h·∫øt h·∫°n
                if(response.status === 400 || response.status === 403) {
                    localStorage.removeItem('geminiKey');
                    throw new Error("Key kh√¥ng h·ª£p l·ªá ho·∫∑c h·∫øt h·∫°n. ƒê√£ x√≥a Key c≈©, vui l√≤ng th·ª≠ l·∫°i.");
                }
                throw new Error(errMsg);
            }

            const data = await response.json();
            if (data.candidates && data.candidates.length > 0) {
                els.text.value = data.candidates[0].content.parts[0].text;
            } else {
                throw new Error("AI kh√¥ng tr·∫£ v·ªÅ n·ªôi dung.");
            }
        } catch (error) {
            alert("L·ªói AI: " + error.message);
        } finally {
            els.aiBtn.innerHTML = originalText;
            els.aiBtn.disabled = false;
            els.text.classList.remove('ai-loading');
        }
    }

    // === 6. GI·ªåNG ƒê·ªåC & TEXT TO SPEECH ===
    function loadVoices() {
      voices = speechSynthesis.getVoices();
      const filtered = voices.filter(v => v.lang.startsWith(globalLang.split('-')[0]));
      
      if (filtered.length > 0) {
          els.voiceSelect.innerHTML = filtered.map(v => `<option value="${v.name}">${v.name} (${v.lang})</option>`).join('');
          const saved = localStorage.getItem('voice');
          selectedVoice = filtered.find(v => v.name === saved) || filtered[0];
          els.voiceSelect.value = selectedVoice.name;
      } else {
          // Chrome c·∫ßn th·ªùi gian ƒë·ªÉ load gi·ªçng
          if(voices.length === 0) setTimeout(loadVoices, 500);
          else els.voiceSelect.innerHTML = '<option>Kh√¥ng c√≥ gi·ªçng ph√π h·ª£p</option>';
      }
    }

    function speak(text, onWord) {
      if (!selectedVoice || currentMode === 'read-only') return;
      speechSynthesis.cancel();
      currentUtterance = new SpeechSynthesisUtterance(text);
      currentUtterance.voice = selectedVoice;
      currentUtterance.rate = speechRate;
      if (onWord) {
        currentUtterance.onboundary = (e) => { if (e.name === 'word') onWord(e.charIndex, e.charLength); };
      }
      speechSynthesis.speak(currentUtterance);
    }

    // === 7. D·ªäCH THU·∫¨T (Optional) ===
    async function translateSingleWord(word, targetElement) {
        if (globalLang === 'vi-VN') return;
        const clean = word.replace(/[.,!?;:"()]/g, "").trim().toLowerCase();
        if (!clean) return;
        if (wordCache[clean]) { targetElement.textContent = wordCache[clean]; return; }

        try {
            targetElement.textContent = "...";
            const res = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(clean)}&langpair=${globalLang.split('-')[0]}|vi`);
            const data = await res.json();
            if(data.responseData.translatedText) {
                wordCache[clean] = data.responseData.translatedText;
                targetElement.textContent = wordCache[clean];
            }
        } catch (e) { targetElement.textContent = "?"; }
    }

    // === 8. LOGIC GAME (CORE) ===
    function showSegment() {
      const text = segments[currentIdx];
      els.next.disabled = true;
      els.input.style.borderColor = ''; els.input.style.boxShadow = ''; els.input.value = ''; els.input.focus();
      correctWords = 0;
      
      els.micBox.classList.toggle('hidden', currentMode !== 'read-only');
      els.input.style.display = currentMode === 'read-only' ? 'none' : 'block';
      els.hint.style.display = currentMode === 'read-only' ? 'none' : 'flex';
      els.feedback.innerHTML = '<em>S·∫µn s√†ng...</em>';
      els.fullTrans.textContent = '';

      // Ch·∫ø ƒë·ªô nghe
      if (currentMode === 'listen-write') {
        els.segment.innerHTML = '<em>(H√£y nghe v√† g√µ l·∫°i...)</em>';
        setTimeout(() => speak(text, () => {}), 600);
        return;
      }

      // Render Karaoke
      const fragment = document.createDocumentFragment();
      let charIndex = 0;
      karaokeWords = [];

      text.split(/([^\s\w]+|\s+)/).forEach(part => {
          if (!part.trim() || /^[.,!?;:"()]+$/.test(part)) {
              fragment.appendChild(document.createTextNode(part));
              charIndex += part.length;
          } else {
              const span = document.createElement('span');
              span.className = 'karaoke-word';
              span.textContent = part;
              span.dataset.start = charIndex;
              span.dataset.end = charIndex + part.length;
              if (globalLang !== 'vi-VN') {
                  const tooltip = document.createElement('div');
                  tooltip.className = 'word-tooltip';
                  span.appendChild(tooltip);
                  span.addEventListener('mouseenter', () => translateSingleWord(part, tooltip));
              }
              karaokeWords.push(span);
              fragment.appendChild(span);
              charIndex += part.length;
          }
      });

      els.segment.innerHTML = '';
      els.segment.appendChild(fragment);
      
      if (currentMode === 'read-listen-write') setTimeout(() => speak(text, highlightKaraoke), 300);
    }

    function highlightKaraoke(charIndex) {
      karaokeWords.forEach(w => w.classList.remove('karaoke-active'));
      const word = karaokeWords.find(w => charIndex >= w.dataset.start && charIndex < w.dataset.end);
      if (word) word.classList.add('karaoke-active');
    }

    function normalize(text) { return text.trim().replace(/[.,!?:;'"‚Äú‚Äù()[\]{}]/g, '').replace(/\s+/g, ' ').toLowerCase(); }

    function updateFeedback() {
      const orig = segments[currentIdx];
      const input = els.input.value;
      const oWords = normalize(orig).split(' ').filter(w=>w);
      const iWords = normalize(input).split(' ').filter(w=>w);
      
      let html = '', correct = 0;
      iWords.forEach((w, i) => {
        if (i >= oWords.length) html += `<span class="wrong">${w}</span> `;
        else if (w === oWords[i]) { correct++; html += `<span class="correct">${w}</span> `; }
        else html += `<span class="wrong">${w}</span> `;
      });
      
      correctWords = correct;
      els.feedback.innerHTML = html || '...';
      
      const isMatch = normalize(input) === normalize(orig);
      els.next.disabled = !isMatch;
      if(isMatch) els.input.style.borderColor = 'var(--success)';
    }

    function next() {
      typedWords += normalize(segments[currentIdx]).split(' ').length;
      totalCorrectWords += correctWords;
      currentIdx++;
      const p = (currentIdx / segments.length) * 100;
      els.progressFill.style.width = p + '%';
      els.progressText.textContent = Math.round(p) + '%';
      if (currentIdx >= segments.length) end(); else showSegment();
    }

    function updateStats() {
      const s = Math.floor((Date.now() - startTime) / 1000);
      els.time.textContent = s + 's';
      const wpm = s > 0 ? Math.round((typedWords / s) * 60) : 0;
      els.wpm.textContent = wpm;
    }

    function end() {
      clearInterval(timer);
      if (isListening) recognition?.stop();
      const s = (Date.now() - startTime) / 1000 / 60;
      const wpm = s > 0 ? Math.round(typedWords / s) : 0;
      const acc = typedWords > 0 ? Math.round((totalCorrectWords / typedWords) * 100) : 100;
      const score = Math.round(wpm * 2 + acc * 1.5);
      const badge = wpm < 40 ? "T√¢n Binh" : wpm < 80 ? "Th√†nh Th·∫°o" : "Cao Th·ªß";

      const entry = { name: playerName || '·∫®n danh', wpm, acc, score, badge };
      personalHistory.push(entry);
      if (personalHistory.length > 10) personalHistory.shift();
      localStorage.setItem('personalHistory', JSON.stringify(personalHistory));
      
      if (!bestStats || score > bestStats.score) {
          bestStats = entry;
          localStorage.setItem('bestStats', JSON.stringify(bestStats));
      }

      els.levelBadge.textContent = badge;
      alert(`K·∫øt th√∫c!\nT·ªëc ƒë·ªô: ${wpm} WPM - ƒêi·ªÉm: ${score}`);
      renderPersonalStats();
      location.reload();
    }

    function initSpeechRecognition() {
      if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
          alert("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ gi·ªçng n√≥i. H√£y d√πng Chrome."); return false;
      }
      const SpeechRecognition = window.webkitSpeechRecognition || window.SpeechRecognition;
      recognition = new SpeechRecognition();
      recognition.lang = globalLang;
      recognition.continuous = false;
      
      recognition.onresult = (e) => {
        const transcript = e.results[0][0].transcript;
        const cleanTrans = normalize(transcript);
        const cleanTarget = normalize(segments[currentIdx]);
        
        els.feedback.innerHTML = cleanTrans === cleanTarget 
            ? `<span class="correct">${transcript}</span> <br> ‚úÖ Ch√≠nh x√°c!` 
            : `<span class="wrong">${transcript}</span> <br> ‚ùå Th·ª≠ l·∫°i!`;
        
        if(cleanTrans === cleanTarget) els.next.disabled = false;
      };
      recognition.onend = () => { els.micBtn.classList.remove('listening'); isListening = false; };
      return true;
    }

    // === 9. S·ª∞ KI·ªÜN & KH·ªûI CH·∫†Y ===
    els.loginBtn.addEventListener('click', () => handleLogin(els.usernameInput.value.trim()));
    els.skipLoginBtn.addEventListener('click', () => handleLogin(coolNicknames[Math.floor(Math.random()*coolNicknames.length)]));
    els.logoutBtn.addEventListener('click', handleLogout);
    
    els.theme.addEventListener('click', toggleBaseTheme);
    els.holidayBtn.addEventListener('click', toggleHolidayMode);
    
    // X·ª≠ l√Ω Tabs
    els.mainTabs().forEach(btn => btn.addEventListener('click', () => {
        els.mainTabs().forEach(t => t.classList.remove('active'));
        btn.classList.add('active');
        els.tabContents().forEach(c => c.classList.toggle('hidden', c.id !== btn.dataset.tab));
        if(btn.dataset.tab === 'rankPanel') renderPersonalStats();
    }));

    // X·ª≠ l√Ω AI
    els.aiBtn.addEventListener('click', handleAIGeneration);
    els.aiResetBtn.addEventListener('click', () => {
        if(confirm("X√≥a Key ƒë√£ l∆∞u?")) { localStorage.removeItem('geminiKey'); alert("ƒê√£ x√≥a!"); }
    });

    // B·∫Øt ƒë·∫ßu
    els.start.addEventListener('click', () => {
      const raw = els.text.value.trim();
      if (!raw) return alert('Ch∆∞a c√≥ n·ªôi dung!');
      segments = raw.split(/[.!?]+/).map(s=>s.trim()).filter(s=>s);
      if(!segments.length) return alert('N·ªôi dung kh√¥ng h·ª£p l·ªá!');

      currentIdx = 0; typedWords = 0; correctWords = 0; startTime = Date.now();
      currentMode = document.querySelector('input[name="mode"]:checked').value;
      speechRate = parseFloat(els.voiceRateSelect.value);
      
      els.modeBtns().forEach(b => b.classList.toggle('active', b.dataset.mode === currentMode));
      
      document.getElementById('setupPanel').classList.add('hidden');
      document.getElementById('practiceArea').classList.remove('hidden');
      
      if(currentMode === 'read-only') initSpeechRecognition();
      timer = setInterval(updateStats, 1000);
      showSegment();
    });

    els.input.addEventListener('input', updateFeedback);
    els.input.addEventListener('keydown', e => { if(e.key==='Enter' && !els.next.disabled) next(); });
    els.replay.addEventListener('click', () => speak(segments[currentIdx], highlightKaraoke));
    els.next.addEventListener('click', next);
    els.reset.addEventListener('click', () => location.reload());
    
    els.micBtn.addEventListener('click', () => {
        if(!recognition && !initSpeechRecognition()) return;
        if(isListening) recognition.stop();
        else { recognition.start(); els.micBtn.classList.add('listening'); isListening=true; }
    });
    
    els.voiceSelect.addEventListener('change', () => {
        selectedVoice = voices.find(v => v.name === els.voiceSelect.value);
        localStorage.setItem('voice', els.voiceSelect.value);
    });

    els.lang.addEventListener('change', () => {
        globalLang = els.lang.value; localStorage.setItem('lang', globalLang); location.reload();
    });

    // Chart v·∫Ω bi·ªÉu ƒë·ªì
    function renderPersonalStats() {
        if (bestStats) {
            els.personalWPM.textContent = bestStats.wpm;
            els.personalAcc.textContent = bestStats.acc + '%';
            els.personalScore.textContent = bestStats.score;
            els.personalBadge.textContent = bestStats.badge;
        }
        if (personalChart) personalChart.destroy();
        const ctx = els.personalChart.getContext('2d');
        personalChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: personalHistory.map((_,i)=>`L·∫ßn ${i+1}`),
                datasets: [{ label: 'WPM', data: personalHistory.map(h=>h.wpm), borderColor: '#8b5cf6', tension: 0.4 }]
            }
        });
    }

    // Init
    window.addEventListener('load', () => {
        if(!localStorage.getItem('baseTheme')) localStorage.setItem('baseTheme', 'light');
        applyTheme(localStorage.getItem('isHoliday')==='true'?'holiday':localStorage.getItem('baseTheme'));
        checkLogin();
        loadVoices();
        if (speechSynthesis.onvoiceschanged !== undefined) speechSynthesis.onvoiceschanged = loadVoices;
    });
  </script>
</body>
</html>
