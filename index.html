<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>HiHi - Luy·ªán Ch√≠nh T·∫£ Th√¥ng Minh (Modern Edition + AI)</title>
  <meta name="description" content="Luy·ªán g√µ chu·∫©n, nghe r√µ, ƒë·ªçc to ‚Äì nh·∫≠n di·ªán gi·ªçng n√≥i, karaoke. T√≠ch h·ª£p AI Gemini.">
  <meta name="theme-color" content="#8b5cf6">
  <link href="https://googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700;800&family=Outfit:wght@400;600;800&family=Mountains+of+Christmas:wght@700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  
  <style>
    :root {
      /* --- M√ÄU S·∫ÆC HI·ªÜN ƒê·∫†I (DEFAULT) --- */
      --bg-gradient: radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), 
                     radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), 
                     radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
      --bg-color: #0f172a;
      
      --glass-surface: rgba(255, 255, 255, 0.75);
      --glass-border: rgba(255, 255, 255, 0.4);
      --glass-blur: 20px;

      --text: #1e293b; 
      --text-dim: #64748b;
      
      /* Gradient ch·ªß ƒë·∫°o: Violet -> Pink */
      --primary-gradient: linear-gradient(135deg, #8b5cf6 0%, #ec4899 100%);
      --primary-shadow: rgba(139, 92, 246, 0.4);
      --primary: #8b5cf6;
      
      --success: #10b981; 
      --danger: #ef4444;
      --warning: #f59e0b;
      --info: #3b82f6;

      --card-radius: 24px;
      --input-radius: 16px;
      --btn-radius: 16px;
      
      --font-main: 'Be Vietnam Pro', sans-serif;
      --font-display: 'Outfit', sans-serif;
      
      --shadow-sm: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
      --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.05);
      --shadow-glow: 0 0 20px rgba(139, 92, 246, 0.3);
    }

    /* DARK MODE */
    [data-theme="dark"] {
      --bg-color: #020617;
      --glass-surface: rgba(15, 23, 42, 0.65); /* T·ªëi m√†u v√† trong su·ªët */
      --glass-border: rgba(255, 255, 255, 0.08);
      --text: #f8fafc;
      --text-dim: #94a3b8;
      --shadow-lg: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    }

    /* HOLIDAY MODE */
    [data-theme*="holiday"] {
      --primary-gradient: linear-gradient(135deg, #dc2626 0%, #16a34a 100%); /* ƒê·ªè - Xanh */
      --primary-shadow: rgba(220, 38, 38, 0.4);
      --primary: #dc2626;
      --bg-color: #0f2b1d;
      --font-display: 'Mountains of Christmas', cursive;
    }
    [data-theme="holiday"] {
      --glass-surface: rgba(255, 255, 255, 0.85);
    }
    [data-theme="holiday-dark"] {
      --glass-surface: rgba(20, 10, 10, 0.75);
      --text: #ffe4e6;
      --bg-color: #1a0505;
    }

    /* --- RESET & BASE --- */
    * { margin:0; padding:0; box-sizing:border-box; -webkit-font-smoothing: antialiased; }
    
    body {
      font-family: var(--font-main);
      background-color: var(--bg-color);
      color: var(--text);
      min-height: 100vh;
      padding: 20px;
      line-height: 1.6;
      overflow-x: hidden;
      position: relative;
      transition: background-color 0.5s ease, color 0.3s ease;
    }

    /* BACKGROUND ANIMATION (AURORA) */
    .aurora-bg {
      position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
      z-index: -1; overflow: hidden; pointer-events: none;
    }
    .aurora-blob {
      position: absolute; filter: blur(80px); opacity: 0.6;
      animation: floatBlob 20s infinite alternate cubic-bezier(0.4, 0, 0.2, 1);
    }
    .blob-1 { top: -10%; left: -10%; width: 50vw; height: 50vw; background: #8b5cf6; animation-delay: 0s; }
    .blob-2 { bottom: -10%; right: -10%; width: 60vw; height: 60vw; background: #ec4899; animation-delay: -5s; }
    .blob-3 { top: 40%; left: 40%; width: 40vw; height: 40vw; background: #3b82f6; animation-delay: -10s; }
    
    [data-theme*="holiday"] .blob-1 { background: #dc2626; }
    [data-theme*="holiday"] .blob-2 { background: #16a34a; }
    [data-theme*="holiday"] .blob-3 { background: #fbbf24; }

    @keyframes floatBlob {
      0% { transform: translate(0, 0) scale(1); }
      100% { transform: translate(20px, 40px) scale(1.1); }
    }

    /* SNOWFLAKES */
    .snowflake {
      position: fixed; top: -10px; z-index: 999; color: #fff; 
      text-shadow: 0 0 5px rgba(255,255,255,0.8); pointer-events: none;
      animation: fall linear forwards; display: none;
    }
    [data-theme*="holiday"] .snowflake { display: block; }
    @keyframes fall { to { transform: translateY(105vh) rotate(360deg); } }

    /* LAYOUT CONTAINER */
    .container {
      max-width: 1100px; margin: 0 auto;
      display: flex; flex-direction: column; gap: 32px;
      position: relative; z-index: 10;
      padding-top: 40px;
    }

    /* GLASS CARD STYLE */
    .glass-card {
      background: var(--glass-surface);
      backdrop-filter: blur(var(--glass-blur));
      -webkit-backdrop-filter: blur(var(--glass-blur));
      border: 1px solid var(--glass-border);
      border-radius: var(--card-radius);
      box-shadow: var(--shadow-lg);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    /* HEADER */
    header {
      padding: 40px 30px;
      text-align: center;
      position: relative;
      overflow: hidden;
    }
    header::before {
      content: ''; position: absolute; top:0; left:0; right:0; height: 6px;
      background: var(--primary-gradient);
    }
    
    .logo {
      display: flex; align-items: center; justify-content: center; gap: 12px;
      margin-bottom: 8px;
    }
    .logo svg { width: 50px; height: 50px; fill: url(#grad1); animation: floatLogo 6s ease-in-out infinite; }
    /* SVG Gradient def in HTML */
    
    .logo h1 {
      font-family: var(--font-display);
      font-size: 3.5rem; font-weight: 800; letter-spacing: -0.03em;
      background: var(--primary-gradient);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      line-height: 1.1;
    }
    .tagline {
      color: var(--text-dim); font-size: 1.1rem; font-weight: 500;
    }
    
    @keyframes floatLogo { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-8px) rotate(2deg)} }

    /* BUTTONS & CONTROLS */
    .theme-toggle-wrapper {
      position: absolute; top: 20px; right: 20px; display: flex; gap: 12px;
    }
    .icon-btn {
      width: 44px; height: 44px; border-radius: 50%; border: none;
      background: var(--glass-surface); color: var(--text);
      border: 1px solid var(--glass-border); cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      transition: 0.3s; box-shadow: var(--shadow-sm);
      font-size: 1.2rem;
    }
    .icon-btn:hover { transform: scale(1.1); background: var(--text); color: var(--bg-color); }
    
    #logoutBtn { color: var(--danger); }
    #logoutBtn:hover { background: var(--danger); color: white; }
    #holidayBtn { color: #16a34a; }
    [data-theme*="holiday"] #holidayBtn { background: #dc2626; color: #fff; border-color: #fbbf24; }

    /* TABS */
    .tabs {
      display: inline-flex; background: var(--glass-surface);
      padding: 6px; border-radius: 20px; border: 1px solid var(--glass-border);
      margin: 0 auto; position: relative;
      box-shadow: var(--shadow-sm);
    }
    .tab {
      padding: 12px 32px; border-radius: 14px; border: none;
      background: transparent; color: var(--text-dim);
      font-weight: 600; font-size: 1rem; cursor: pointer;
      transition: 0.3s; font-family: var(--font-main);
    }
    .tab.active {
      background: var(--primary-gradient); color: white;
      box-shadow: 0 4px 12px var(--primary-shadow);
    }

    /* INPUT NAME */
    .name-box { text-align: center; margin-bottom: 10px; }
    .name-box input {
      background: transparent; border: none; border-bottom: 2px solid var(--glass-border);
      text-align: center; font-size: 1.2rem; color: var(--text); font-weight: 700;
      width: 300px; padding: 8px; font-family: var(--font-display);
    }
    .name-box input:focus { outline: none; border-color: var(--primary); }

    /* SETUP GRID */
    .setup-grid {
      padding: 40px;
      display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 24px;
    }
    .setup-item {
      background: rgba(255,255,255,0.05); border-radius: var(--input-radius);
      padding: 24px; border: 1px solid var(--glass-border);
    }
    .setup-item h3 {
      font-size: 1.1rem; margin-bottom: 16px; color: var(--primary);
      display: flex; align-items: center; gap: 8px; font-weight: 700;
    }
    .setup-item h3 svg { width: 20px; fill: var(--primary); }

    select, textarea, input[type="text"] {
      width: 100%; padding: 14px 16px;
      border: 2px solid var(--glass-border); border-radius: var(--input-radius);
      background: rgba(255,255,255,0.5); color: #0f172a; /* Lu√¥n t·ªëi ƒë·ªÉ d·ªÖ ƒë·ªçc tr√™n n·ªÅn k√≠nh */
      font-family: var(--font-main); font-size: 1rem; transition: 0.3s;
    }
    [data-theme="dark"] select, [data-theme="dark"] textarea, [data-theme="dark"] input[type="text"] {
       background: rgba(0,0,0,0.3); color: #fff; border-color: rgba(255,255,255,0.1);
    }

    select:focus, textarea:focus, input[type="text"]:focus {
      outline: none; border-color: var(--primary);
      box-shadow: 0 0 0 4px var(--primary-shadow);
    }
    
    /* AI Loading Animation */
    @keyframes shimmer {
      0% { background-position: -1000px 0; }
      100% { background-position: 1000px 0; }
    }
    .ai-loading {
      background: linear-gradient(to right, rgba(255,255,255,0.1) 8%, rgba(255,255,255,0.2) 18%, rgba(255,255,255,0.1) 33%);
      background-size: 1000px 100%;
      animation: shimmer 1.5s infinite linear;
      opacity: 0.7; pointer-events: none;
    }

    /* RADIO CUSTOM */
    .radio-group { display: flex; flex-direction: column; gap: 10px; }
    .radio-label {
      display: flex; align-items: center; gap: 12px; padding: 12px;
      border-radius: 12px; cursor: pointer; transition: 0.2s;
      border: 1px solid transparent;
    }
    .radio-label:hover { background: rgba(139, 92, 246, 0.1); }
    .radio-label:has(input:checked) {
      background: rgba(139, 92, 246, 0.15); border-color: var(--primary); font-weight: 600;
    }
    input[type="radio"] { accent-color: var(--primary); width: 18px; height: 18px; }

    /* MAIN BUTTON */
    .start-btn {
      grid-column: 1/-1;
      margin-top: 10px; padding: 20px;
      background: var(--primary-gradient);
      color: white; font-weight: 700; font-size: 1.25rem;
      border: none; border-radius: var(--btn-radius);
      cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;
      box-shadow: 0 10px 20px var(--primary-shadow);
      transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      text-transform: uppercase; letter-spacing: 1px;
    }
    .start-btn:hover { transform: translateY(-4px) scale(1.02); box-shadow: 0 15px 30px var(--primary-shadow); }
    .start-btn:active { transform: translateY(-1px); }

    /* PRACTICE AREA */
    #practiceArea, #rankPanel { padding: 40px; }
    
    .mode-switcher { display: flex; justify-content: center; gap: 8px; margin-bottom: 24px; }
    .mode-btn {
      padding: 8px 20px; border-radius: 30px; border: 1px solid var(--glass-border);
      background: transparent; color: var(--text); font-weight: 600; cursor: pointer;
      transition: 0.3s; font-size: 0.9rem;
    }
    .mode-btn.active { background: var(--text); color: var(--bg-color); border-color: transparent; }

    .progress-box { margin-bottom: 20px; }
    .progress-bar {
      height: 12px; background: rgba(0,0,0,0.1); border-radius: 10px; overflow: hidden;
    }
    [data-theme="dark"] .progress-bar { background: rgba(255,255,255,0.1); }
    .progress-fill {
      height: 100%; background: var(--primary-gradient); width: 0;
      border-radius: 10px; transition: width 0.5s ease;
    }

    .segment-box {
      font-size: 1.6rem; line-height: 1.8; text-align: center;
      min-height: 160px; padding: 40px;
      background: rgba(255,255,255,0.5); border-radius: 20px;
      border: 2px dashed var(--primary); margin-bottom: 24px;
      color: var(--text); font-weight: 600;
      display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 8px;
    }
    [data-theme="dark"] .segment-box { background: rgba(0,0,0,0.2); border-color: var(--text-dim); }
    
    .karaoke-word {
      padding: 4px 8px; border-radius: 8px; transition: 0.2s; position: relative;
    }
    .karaoke-active {
      background: var(--primary); color: white !important; transform: scale(1.1);
      box-shadow: 0 4px 12px var(--primary-shadow); z-index: 10;
    }
    .word-tooltip {
        position: absolute; bottom: 110%; left: 50%; transform: translateX(-50%);
        background: #1e293b; color: white; padding: 4px 8px; border-radius: 6px;
        font-size: 0.8rem; opacity: 0; pointer-events: none; transition: 0.2s;
        white-space: nowrap;
    }
    .karaoke-word:hover .word-tooltip { opacity: 1; transform: translateX(-50%) translateY(-5px); }

    .input-wrapper { position: relative; margin: 30px 0; }
    #userInput {
      font-size: 1.5rem; padding: 20px 60px 20px 24px;
      border-radius: 24px; border: 2px solid var(--glass-border);
      box-shadow: var(--shadow-sm);
    }
    .hint-btn {
      position: absolute; right: 16px; top: 50%; transform: translateY(-50%);
      width: 40px; height: 40px; border-radius: 12px;
      background: #8b5cf6; color: white; border: none; font-weight: bold;
      cursor: pointer; display: flex; align-items: center; justify-content: center;
    }

    #liveFeedback {
      font-family: 'Courier New', monospace; font-size: 1.2rem;
      min-height: 50px; margin-bottom: 30px; color: var(--text-dim);
    }
    .correct { color: var(--success); font-weight: 700; }
    .wrong { color: var(--danger); text-decoration: line-through; opacity: 0.7; }

    /* ACTION BUTTONS */
    .action-row { display: flex; justify-content: center; gap: 16px; flex-wrap: wrap; }
    .action-btn {
      padding: 16px 32px; border-radius: 16px; border: none;
      font-weight: 700; font-size: 1rem; cursor: pointer;
      display: flex; align-items: center; gap: 10px; transition: 0.3s;
      color: white; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    .action-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }
    .action-btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0,0,0,0.15); }

    .btn-replay { background: var(--warning); }
    .btn-next { background: var(--success); }
    .btn-reset { background: var(--glass-surface); color: var(--text); border: 1px solid var(--glass-border); }
    
    /* STATS */
    .stats-row {
      display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-top: 40px;
    }
    .stat-item {
      background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border);
      padding: 16px; border-radius: 16px; text-align: center;
    }
    .stat-item h4 { font-size: 0.85rem; color: var(--text-dim); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; }
    .stat-item .val { font-size: 1.8rem; font-weight: 800; color: var(--primary); font-family: var(--font-display); }

    /* BADGE & MODAL */
    .level-badge {
      display: inline-block; padding: 8px 24px; border-radius: 30px;
      background: var(--primary-gradient); color: white; font-weight: 700;
      box-shadow: var(--shadow-glow); margin-top: 20px;
    }

    .modal {
      position: fixed; top:0; left:0; width:100%; height:100%; z-index: 2000;
      background: rgba(0,0,0,0.6); backdrop-filter: blur(5px);
      display: flex; align-items: center; justify-content: center;
      opacity: 0; visibility: hidden; transition: 0.3s;
    }
    .modal.show { opacity: 1; visibility: visible; }
    .modal-content {
      background: var(--bg-color); border: 1px solid var(--glass-border);
      padding: 40px; border-radius: 32px; width: 90%; max-width: 450px;
      text-align: center; box-shadow: var(--shadow-lg);
    }
    .modal h3 { font-family: var(--font-display); font-size: 1.8rem; margin-bottom: 24px; color: var(--primary); }

    /* RESPONSIVE */
    @media (max-width: 768px) {
      .logo h1 { font-size: 2.5rem; }
      .stats-row { grid-template-columns: 1fr 1fr; }
      .setup-grid { grid-template-columns: 1fr; padding: 24px; }
      #userInput { font-size: 1.2rem; }
    }

    /* UTILS */
    .hidden { display: none !important; }
    .mic-btn {
      width: 70px; height: 70px; border-radius: 50%; background: var(--danger); color: white;
      font-size: 2rem; border: none; cursor: pointer; margin: 0 auto 20px; display: block;
      transition: 0.3s; box-shadow: 0 8px 20px rgba(239, 68, 68, 0.4);
    }
    .mic-btn.listening { background: var(--success); animation: pulseMic 1.5s infinite; }
    @keyframes pulseMic { 0% { box-shadow: 0 0 0 0 rgba(16,185,129,0.7); } 70% { box-shadow: 0 0 0 20px transparent; } 100% { box-shadow: 0 0 0 0 transparent; } }

    /* SVG Gradients Defs (Hidden visually but used) */
    .svg-defs { width: 0; height: 0; position: absolute; }
  </style>
</head>
<body>

  <div class="aurora-bg">
    <div class="aurora-blob blob-1"></div>
    <div class="aurora-blob blob-2"></div>
    <div class="aurora-blob blob-3"></div>
  </div>
  
  <div id="snowContainer"></div>
  
  <svg class="svg-defs">
    <defs>
      <linearGradient id="grad1" x1="0%" y1="0%" x2="100%" y2="0%">
        <stop offset="0%" style="stop-color:#8b5cf6;stop-opacity:1" />
        <stop offset="100%" style="stop-color:#ec4899;stop-opacity:1" />
      </linearGradient>
    </defs>
  </svg>

  <div id="browserWarning" style="display:none; background:#fef3c7; color:#92400e; padding:10px; text-align:center; font-weight:600;">
    ‚ö†Ô∏è Web ch·∫°y t·ªët nh·∫•t tr√™n Chrome/Edge PC
    <span class="close-warn" onclick="this.parentElement.style.display='none'" style="cursor:pointer; margin-left:10px;">&times;</span>
  </div>

  <div class="container">
    <header class="glass-card">
      <div class="theme-toggle-wrapper">
        <button class="icon-btn" id="holidayBtn" title="Ch·∫ø ƒë·ªô Gi√°ng Sinh">üéÑ</button>
        <button class="icon-btn" id="themeBtn" title="ƒê·ªïi giao di·ªán S√°ng/T·ªëi">
           <span id="sunIcon">‚òÄÔ∏è</span><span id="moonIcon" class="hidden">üåô</span>
        </button>
        <div id="logoutBtnWrapper" class="hidden">
            <button class="icon-btn" id="logoutBtn" title="ƒêƒÉng xu·∫•t">üö™</button>
        </div>
      </div>

      <div class="logo">
        <svg viewBox="0 0 24 24">
          <path d="M20 2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h14l4 4V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/>
        </svg>
        <h1>HiHi<span style="font-size:0.4em; vertical-align: super; opacity: 0.8;">2026</span></h1>
      </div>
      <p class="tagline">Luy·ªán ch√≠nh t·∫£ & ngo·∫°i ng·ªØ phong c√°ch m·ªõi üöÄ</p>
    </header>

    <div class="tabs">
      <button class="tab active" data-tab="setupPanel">Luy·ªán T·∫≠p</button>
      <button class="tab" data-tab="rankPanel">Th·ªëng K√™</button>
    </div>

    <div class="name-box">
      <input type="text" id="playerName" placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n..." maxlength="20" readonly />
    </div>

    <div id="setupPanel" class="tab-content glass-card">
      <div class="setup-grid">
        <div class="setup-item">
          <h3>üåç Ng√¥n ng·ªØ</h3>
          <select id="globalLang">
            <option value="vi-VN">Ti·∫øng Vi·ªát (G·ªëc)</option>
            <option value="en-US">Ti·∫øng Anh ‚Üí Vi·ªát</option>
            <option value="id-ID">Ti·∫øng Indonesia ‚Üí Vi·ªát</option>
          </select>
        </div>

        <div class="setup-item">
          <h3>üéÆ Ch·∫ø ƒë·ªô ch∆°i</h3>
          <div class="radio-group">
            <label class="radio-label"><input type="radio" name="mode" value="read-write" checked> <span>Nh√¨n & Ch√©p</span></label>
            <label class="radio-label"><input type="radio" name="mode" value="listen-write"> <span>Nghe & Ch√©p</span></label>
            <label class="radio-label"><input type="radio" name="mode" value="read-listen-write"> <span>Nghe - Nh√¨n - Ch√©p</span></label>
            <label class="radio-label"><input type="radio" name="mode" value="read-only"> <span>Luy·ªán ƒê·ªçc (Mic)</span></label>
          </div>
        </div>
        
        <div class="setup-item">
          <h3>üîä Gi·ªçng ƒë·ªçc AI</h3>
          <div style="display:flex; flex-direction:column; gap:12px;">
             <select id="voiceSelect"></select>
             <div style="display:flex; gap:10px;">
                 <select id="voiceRateSelect" style="flex:1;">
                    <option value="0.75">0.75x (Ch·∫≠m)</option>
                    <option value="1.00" selected>1.00x (Chu·∫©n)</option>
                    <option value="1.25">1.25x (Nhanh)</option>
                    <option value="1.50">1.50x (R·∫•t nhanh)</option>
                  </select>
                  <button id="previewVoice" class="icon-btn" style="border-radius:12px; width:auto; padding:0 16px;">üîâ Th·ª≠</button>
             </div>
          </div>
        </div>

        <div class="setup-item" style="grid-column: 1/-1;">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
             <h3>‚úçÔ∏è D·ªØ li·ªáu ƒë·∫ßu v√†o</h3>
             <button id="aiGenerateBtn" class="icon-btn" style="width:auto; padding:0 15px; font-size:0.9rem; border-radius:12px; background:var(--primary-gradient); color:white; border:none; font-weight:600;">
               ‚ú® AI Vi·∫øt B√†i
             </button>
          </div>
          <textarea id="sampleText" rows="4" placeholder="D√°n ƒëo·∫°n vƒÉn b·∫°n mu·ªën luy·ªán v√†o ƒë√¢y..."></textarea>
        </div>

        <button class="start-btn" id="startBtn">
          <svg style="width:24px;height:24px;fill:currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
          B·∫Øt ƒë·∫ßu luy·ªán t·∫≠p
        </button>
      </div>
    </div>

    <div id="rankPanel" class="tab-content glass-card hidden">
      <h2 style="text-align:center; color:var(--primary); font-family:var(--font-display);">Th√†nh T√≠ch C√° Nh√¢n</h2>
      <div id="personalStats">
        <div class="stats-row" id="personalStatsRow">
          <div class="stat-item"><h4>WPM Max</h4><div class="val" id="personalWPM">0</div></div>
          <div class="stat-item"><h4>Ch√≠nh x√°c</h4><div class="val" id="personalAcc">0%</div></div>
          <div class="stat-item"><h4>S·ªë c√¢u</h4><div class="val" id="personalSentences">0</div></div> 
          <div class="stat-item"><h4>ƒêi·ªÉm cao</h4><div class="val"id="personalScore">0</div></div>
        </div>
        <div style="text-align:center; margin-top:20px;"><span class="level-badge" id="personalBadge">H·∫°ng: T√¢n binh</span></div>
        <div style="margin-top: 40px; padding:20px; background:rgba(255,255,255,0.5); border-radius:20px;">
             <canvas id="personalChart"></canvas>
        </div>
      </div>
    </div>

    <div class="modal" id="loginModal">
      <div class="modal-content">
        <h3>Xin ch√†o! üëã</h3>
        <p style="margin-bottom:20px; color:var(--text-dim);">Nh·∫≠p t√™n ƒë·ªÉ l∆∞u l·∫°i chi·∫øn t√≠ch nh√©.</p>
        <input type="text" id="usernameInput" placeholder="T√™n c·ªßa b·∫°n..." maxlength="20" style="margin-bottom:20px; text-align:center;" />
        <div style="display:flex; gap:10px;">
          <button class="action-btn btn-reset" id="skipLoginBtn" style="flex:1; justify-content:center;">B·ªè qua</button>
          <button class="action-btn btn-next" id="loginBtn" style="flex:1; justify-content:center; background:var(--primary-gradient);">V√†o ngay</button>
        </div>
      </div>
    </div>

    <div id="practiceArea" class="tab-content glass-card hidden">
      <div class="mode-switcher">
        <button class="mode-btn active" data-mode="read-write">Ch√©p</button>
        <button class="mode-btn" data-mode="listen-write">Nghe</button>
        <button class="mode-btn" data-mode="read-listen-write">Nghe-Ch√©p</button>
        <button class="mode-btn" data-mode="read-only">ƒê·ªçc</button>
      </div>

      <div class="progress-box">
        <div style="display:flex; justify-content:space-between; margin-bottom:8px; font-weight:600; font-size:0.9rem;">
          <span>Ti·∫øn tr√¨nh</span> <span id="progressText">0%</span>
        </div>
        <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
      </div>

      <div class="segment-box" id="currentSegment"></div>

      <div class="mic-box hidden" id="micBox">
        <button class="mic-btn" id="micBtn">üé§</button>
        <p style="text-align:center; color:var(--text-dim);">Nh·∫•n mic v√† ƒë·ªçc to ƒëo·∫°n vƒÉn tr√™n</p>
      </div>

      <div id="fullText" style="color:var(--info); font-style:italic; text-align:center; margin-bottom:16px; min-height:24px;"></div>

      <div class="input-wrapper">
        <input type="text" id="userInput" placeholder="G√µ l·∫°i n·ªôi dung ·ªü ƒë√¢y..." autocomplete="off" />
        <button class="hint-btn" id="hintBtn" title="G·ª£i √Ω t·ª´ ti·∫øp theo">?</button>
      </div>

      <div id="liveFeedback" style="text-align:center;"><em>K·∫øt qu·∫£ s·∫Ω hi·ªán ·ªü ƒë√¢y...</em></div>

      <div class="action-row">
        <button class="action-btn btn-replay" id="replayBtn">üîä Nghe l·∫°i</button>
        <button class="action-btn btn-next" id="nextBtn" disabled>Ti·∫øp theo ‚û°Ô∏è</button>
        <button class="action-btn btn-reset" id="resetBtn">Tho√°t</button>
      </div>

      <div class="stats-row">
        <div class="stat-item"><h4>Th·ªùi gian</h4><div class="val" id="time">0s</div></div>
        <div class="stat-item"><h4>T·ªëc ƒë·ªô</h4><div class="val" id="wpm">0</div></div>
        <div class="stat-item"><h4>Ch√≠nh x√°c</h4><div class="val" id="accuracy">100%</div></div>
        <div class="stat-item"><h4>ƒêi·ªÉm</h4><div class="val" id="score">0</div></div>
      </div>
      
      <div style="text-align:center;">
        <div class="level-badge" id="levelBadge" style="margin-top:30px;">C·∫•p ƒë·ªô: M·ªõi b·∫Øt ƒë·∫ßu</div>
        <div id="level" class="hidden"></div> </div>
      <canvas id="mainChart" class="hidden"></canvas>
    </div>

    <footer style="text-align:center; margin-top:40px; color:var(--text-dim); font-size:0.9rem;">
      <p>¬© 2026 HiHi App. Made with ‚ù§Ô∏è & ‚ú®</p>
    </footer>
  </div>

  <script>
    // === 1. H·∫∞NG S·ªê & C·∫§U H√åNH ===
    const coolNicknames = [
      "Chi·∫øn Binh B√†n Ph√≠m", "Vua G√µ Ch·ªØ", "Th·∫ßn T·ªëc", "HiHi Pro", "Ninja Luy·ªán G√µ",
      "Si√™u Anh H√πng G√µ", "Chuy√™n Gia Ch√≠nh T·∫£", "Ng∆∞·ªùi B·∫°n C·ªßa Ch·ªØ", "ƒê√¥i Tay V√†ng"
    ];
    const wordCache = {}; // Cache ƒë·ªÉ l∆∞u t·ª´ ƒë√£ d·ªãch

    // === 2. BI·∫æN TO√ÄN C·ª§C ===
    let typedWords = 0;
    let correctWords = 0;
    let totalCorrectWords = 0;
    let hintsUsed = 0;
    let totalSentences = 0; 
    
    let personalHistory = JSON.parse(localStorage.getItem('personalHistory')) || [];
    let bestStats = JSON.parse(localStorage.getItem('bestStats')) || null;
    let personalChart;
    
    let speechRate = 1.0;
    let currentUtterance = null;
    let currentMode = 'read-write';
    let recognition = null;
    let isListening = false;
    let karaokeWords = [];
    let playerName = '';
    let globalLang = localStorage.getItem('lang') || 'vi-VN';
    let voices = [];
    let selectedVoice = null;
    
    let segments = [];
    let currentIdx = 0;
    let startTime = 0;
    let timer = null;

    // === 3. CH·ªåN PH·∫¶N T·ª¨ (DOM) ===
    const els = {
      lang: document.getElementById('globalLang'),
      text: document.getElementById('sampleText'),
      start: document.getElementById('startBtn'),
      segment: document.getElementById('currentSegment'),
      input: document.getElementById('userInput'),
      feedback: document.getElementById('liveFeedback'),
      fullTrans: document.getElementById('fullText'),
      progressFill: document.getElementById('progressFill'),
      progressText: document.getElementById('progressText'),
      time: document.getElementById('time'),
      wpm: document.getElementById('wpm'),
      acc: document.getElementById('accuracy'),
      level: document.getElementById('level'),
      score: document.getElementById('score'),
      levelBadge: document.getElementById('levelBadge'),
      replay: document.getElementById('replayBtn'),
      hint: document.getElementById('hintBtn'),
      next: document.getElementById('nextBtn'),
      reset: document.getElementById('resetBtn'),
      theme: document.getElementById('themeBtn'),
      holidayBtn: document.getElementById('holidayBtn'), 
      sun: document.getElementById('sunIcon'),
      moon: document.getElementById('moonIcon'),
      voiceSelect: document.getElementById('voiceSelect'),
      voiceRateSelect: document.getElementById('voiceRateSelect'),
      previewVoice: document.getElementById('previewVoice'),
      modeBtns: () => document.querySelectorAll('.mode-btn'),
      micBox: document.getElementById('micBox'),
      micBtn: document.getElementById('micBtn'),
      playerName: document.getElementById('playerName'),
      mainTabs: () => document.querySelectorAll('.tab'),
      tabContents: () => document.querySelectorAll('.tab-content'),
      personalStatsRow: document.getElementById('personalStatsRow'),
      personalWPM: document.getElementById('personalWPM'),
      personalAcc: document.getElementById('personalAcc'),
      personalScore: document.getElementById('personalScore'),
      personalSentences: document.getElementById('personalSentences'),
      personalBadge: document.getElementById('personalBadge'),
      personalChart: document.getElementById('personalChart'),
      loginModal: document.getElementById('loginModal'),
      usernameInput: document.getElementById('usernameInput'),
      loginBtn: document.getElementById('loginBtn'),
      skipLoginBtn: document.getElementById('skipLoginBtn'),
      logoutBtn: document.getElementById('logoutBtn'),
      logoutBtnWrapper: document.getElementById('logoutBtnWrapper'),
      aiBtn: document.getElementById('aiGenerateBtn') // Added AI Button
    };

    // === 4. ƒê·ªäNH NGHƒ®A H√ÄM ===

    // === H·ªÜ TH·ªêNG T√ÄI KHO·∫¢N ===
    function handleLogin(name) {
      if (!name) return;
      playerName = name;
      localStorage.setItem('hihiUser', JSON.stringify({ name: playerName }));
      els.playerName.value = playerName;
      els.playerName.readOnly = true;
      els.loginModal.classList.remove('show');
      els.logoutBtnWrapper.classList.remove('hidden');
    }

    function handleLogout() {
      localStorage.removeItem('hihiUser');
      playerName = '';
      els.playerName.value = '';
      els.playerName.readOnly = true;
      els.logoutBtnWrapper.classList.add('hidden');
      els.loginModal.classList.add('show');
      els.usernameInput.value = '';
    }

    function checkLogin() {
      const user = localStorage.getItem('hihiUser');
      if (user) handleLogin(JSON.parse(user).name);
      else els.loginModal.classList.add('show');
    }
    
    // === CH·ª¶ ƒê·ªÄ & GI√ÅNG SINH ===
    function createSnowflakes() {
        const snowContainer = document.getElementById('snowContainer');
        snowContainer.innerHTML = '';
        for (let i = 0; i < 30; i++) {
            const flake = document.createElement('div');
            flake.className = 'snowflake';
            flake.textContent = ['‚ùÑ', '‚ùÖ', '‚ùÜ'][Math.floor(Math.random() * 3)];
            flake.style.left = Math.random() * 100 + 'vw';
            flake.style.animationDuration = Math.random() * 3 + 2 + 's';
            flake.style.fontSize = Math.random() * 10 + 10 + 'px';
            flake.style.opacity = Math.random();
            flake.style.animationDelay = Math.random() * 5 + 's';
            snowContainer.appendChild(flake);
        }
    }

    function isHolidaySeason() {
        const now = new Date();
        const month = now.getMonth(); // 0 = Jan, 11 = Dec
        const date = now.getDate();
        const year = now.getFullYear();
        
        // B·∫Øt ƒë·∫ßu ch√≠nh x√°c t·ª´ ng√†y 10 th√°ng 12
        if (month === 11 && date >= 10) return true;
        
        // (T√πy ch·ªçn) K√©o d√†i ƒë·∫øn ƒë·∫ßu th√°ng 1 nƒÉm sau
        if (month === 0 && date <= 5) return true;
        
        return false;
    }

    function applyTheme(themeMode) {
        const body = document.body;
        const isDarkPreferred = localStorage.getItem('baseTheme') === 'dark';

        if (themeMode === 'holiday') {
            body.setAttribute('data-theme', isDarkPreferred ? 'holiday-dark' : 'holiday');
        } else {
            body.setAttribute('data-theme', isDarkPreferred ? 'dark' : 'light');
        }

        els.sun.classList.toggle('hidden', !isDarkPreferred);
        els.moon.classList.toggle('hidden', isDarkPreferred);
        
        if (themeMode === 'holiday') createSnowflakes();
        else document.getElementById('snowContainer').innerHTML = '';
    }

    function toggleBaseTheme() {
        const current = localStorage.getItem('baseTheme') === 'dark' ? 'dark' : 'light';
        const next = current === 'dark' ? 'light' : 'dark';
        localStorage.setItem('baseTheme', next);
        
        const isHolidayOn = localStorage.getItem('isHoliday') === 'true';
        applyTheme(isHolidayOn ? 'holiday' : next);
    }

    function toggleHolidayMode() {
        const isCurrentlyOn = localStorage.getItem('isHoliday') === 'true';
        const nextState = !isCurrentlyOn;
        localStorage.setItem('isHoliday', nextState);
        
        const base = localStorage.getItem('baseTheme') || 'light';
        applyTheme(nextState ? 'holiday' : base);
    }

    function initTheme() {
        if (!localStorage.getItem('baseTheme')) localStorage.setItem('baseTheme', 'light');

        // Ch·ªâ t·ª± ƒë·ªông b·∫≠t n·∫øu ƒë√∫ng m√πa (sau 10/12) v√† ch∆∞a thi·∫øt l·∫≠p
        if (isHolidaySeason()) {
            if (localStorage.getItem('autoHolidaySet') !== 'true') {
                localStorage.setItem('isHoliday', 'true');
                localStorage.setItem('autoHolidaySet', 'true');
            }
        }
        
        const isHoliday = localStorage.getItem('isHoliday') === 'true';
        const base = localStorage.getItem('baseTheme');
        applyTheme(isHoliday ? 'holiday' : base);
    }

    // === GEMINI AI INTEGRATION ===
    async function handleAIGeneration() {
        let apiKey = localStorage.getItem('geminiKey');
        
        if (!apiKey) {
            apiKey = prompt("Vui l√≤ng nh·∫≠p Gemini API Key c·ªßa b·∫°n (L∆∞u √Ω: Key s·∫Ω ƒë∆∞·ª£c l∆∞u tr√™n tr√¨nh duy·ªát c·ªßa b·∫°n):");
            if (apiKey) {
                localStorage.setItem('geminiKey', apiKey);
            } else {
                return; // Ng∆∞·ªùi d√πng h·ªßy
            }
        }

        const topic = prompt("B·∫°n mu·ªën AI vi·∫øt v·ªÅ ch·ªß ƒë·ªÅ g√¨? (V√≠ d·ª•: Truy·ªán c∆∞·ªùi, B√†i h·ªçc cu·ªôc s·ªëng, ƒêo·∫°n vƒÉn ti·∫øng Anh B1...):", "C√¢u chuy·ªán ng·∫Øn √Ω nghƒ©a");
        if (!topic) return;

        const btn = els.aiBtn;
        const originalText = btn.innerHTML;
        btn.innerHTML = "‚è≥ ƒêang vi·∫øt...";
        btn.disabled = true;
        els.text.classList.add('ai-loading');

        try {
            const langInstruction = globalLang === 'vi-VN' ? 'b·∫±ng Ti·∫øng Vi·ªát' : (globalLang === 'en-US' ? 'in English' : 'in Indonesian');
            const promptText = `H√£y vi·∫øt m·ªôt ƒëo·∫°n vƒÉn ng·∫Øn (kho·∫£ng 3-5 c√¢u) v·ªÅ ch·ªß ƒë·ªÅ: "${topic}" ${langInstruction}. Ch·ªâ tr·∫£ v·ªÅ n·ªôi dung vƒÉn b·∫£n thu·∫ßn t√∫y, kh√¥ng c√≥ markdown, kh√¥ng c√≥ ti√™u ƒë·ªÅ.`;

            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: promptText }] }]
                })
            });

            const data = await response.json();
            if (data.candidates && data.candidates.length > 0) {
                const generatedText = data.candidates[0].content.parts[0].text;
                els.text.value = generatedText;
            } else {
                alert("Kh√¥ng th·ªÉ t·∫°o n·ªôi dung. Vui l√≤ng ki·ªÉm tra l·∫°i API Key ho·∫∑c th·ª≠ l·∫°i sau.");
                localStorage.removeItem('geminiKey'); // X√≥a key n·∫øu l·ªói ƒë·ªÉ nh·∫≠p l·∫°i
            }
        } catch (error) {
            console.error(error);
            alert("L·ªói k·∫øt n·ªëi ƒë·∫øn Gemini AI!");
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
            els.text.classList.remove('ai-loading');
        }
    }

    // === TABS ===
    function setupTabs(tabButtons, tabContents) {
        tabButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                const targetId = btn.dataset.tab;
                tabButtons.forEach(t => t.classList.remove('active'));
                btn.classList.add('active');
                tabContents.forEach(c => c.classList.toggle('hidden', c.id !== targetId));
                
                if (btn.dataset.tab === 'rankPanel') renderPersonalStats();
            });
        });
    }

    function renderPersonalStats() {
      if (bestStats) {
        els.personalWPM.textContent = bestStats.wpm;
        els.personalAcc.textContent = bestStats.acc + '%';
        els.personalScore.textContent = bestStats.score;
        els.personalSentences.textContent = bestStats.sentences || 0;
        els.personalBadge.textContent = bestStats.badge;
      }
      
      const ctx = els.personalChart.getContext('2d');
      if (personalChart) personalChart.destroy();
      const recentHistory = [...personalHistory].reverse();
      
      personalChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: recentHistory.map((_,i) => `L·∫ßn ${i+1}`),
          datasets: [
            { label: 'WPM', data: recentHistory.map(h=>h.wpm), borderColor: '#8b5cf6', tension: 0.4, fill: true, backgroundColor: 'rgba(139, 92, 246, 0.2)' },
            { label: 'ƒêi·ªÉm', data: recentHistory.map(h=>h.score), borderColor: '#ec4899', tension: 0.4 }
          ]
        },
        options: { responsive: true, plugins: { legend: { position: 'top' } }, scales: { y: { beginAtZero: true } } }
      });
    }

    // === GI·ªåNG ƒê·ªåC ===
    function loadVoices() {
      voices = speechSynthesis.getVoices().filter(v => v.lang.startsWith(globalLang.split('-')[0]));
      els.voiceSelect.innerHTML = voices.length ? voices.map(v => `<option value="${v.name}">${v.name} (${v.lang})</option>`).join('') : '<option>Kh√¥ng t√¨m th·∫•y gi·ªçng ph√π h·ª£p</option>';
      const saved = localStorage.getItem('voice');
      selectedVoice = voices.find(v => v.name === saved) || voices[0];
      if (selectedVoice) els.voiceSelect.value = selectedVoice.name;
    }

    function speak(text, onWord) {
      if (!selectedVoice || currentMode === 'read-only') return;
      speechSynthesis.cancel();
      currentUtterance = new SpeechSynthesisUtterance(text);
      currentUtterance.voice = selectedVoice;
      currentUtterance.rate = speechRate;
      currentUtterance.lang = globalLang;
      if (onWord) {
        currentUtterance.onboundary = (e) => {
          if (e.name === 'word') onWord(e.charIndex, e.charLength);
        };
      }
      speechSynthesis.speak(currentUtterance);
    }
    
    // === D·ªäCH THU·∫¨T ===
    async function translateFull(text, src) {
      if (!text.trim() || globalLang === 'vi-VN') return text;
      try {
        const res = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=${src}|vi`);
        const data = await res.json();
        return data.responseData.translatedText || text;
      } catch { return text; }
    }

    async function translateSingleWord(word, targetElement) {
        if (globalLang === 'vi-VN') return;
        const cleanWord = word.replace(/[.,!?;:"()]/g, "").trim().toLowerCase();
        if (!cleanWord) return;

        if (wordCache[cleanWord]) {
            targetElement.textContent = wordCache[cleanWord];
            return;
        }

        try {
            const src = globalLang.split('-')[0];
            targetElement.textContent = "..."; 
            const res = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(cleanWord)}&langpair=${src}|vi`);
            const data = await res.json();
            const result = data.responseData.translatedText;
            
            if (result) {
                wordCache[cleanWord] = result;
                targetElement.textContent = result;
            } else {
                targetElement.textContent = "?";
            }
        } catch (e) {
            targetElement.textContent = "?";
        }
    }

    // === HI·ªÇN TH·ªä ƒêO·∫†N VƒÇN ===
    async function showSegment() {
      const text = segments[currentIdx];
      els.next.disabled = true;
      els.input.style.borderColor = ''; els.input.style.boxShadow = ''; els.input.value = ''; els.input.focus();
      correctWords = 0;
      
      els.micBox.classList.toggle('hidden', currentMode !== 'read-only');
      const isReadOnly = currentMode === 'read-only';
      els.input.style.display = isReadOnly ? 'none' : 'block';
      els.hint.style.display = isReadOnly ? 'none' : 'flex';
      els.feedback.style.display = 'block';
      els.feedback.innerHTML = '<em>Nh·∫≠p ho·∫∑c ƒë·ªçc ƒë·ªÉ b·∫Øt ƒë·∫ßu...</em>';
      
      const srcLang = globalLang.split('-')[0];
      
      if (globalLang !== 'vi-VN') {
          els.fullTrans.innerHTML = '<em>ƒêang d·ªãch...</em>';
          translateFull(text, srcLang).then(trans => {
              els.fullTrans.textContent = 'T·∫°m d·ªãch: ' + trans;
          });
      } else {
          els.fullTrans.textContent = '';
      }

      if (currentMode === 'listen-write') {
        els.segment.innerHTML = '<em>(H√£y nghe v√† g√µ l·∫°i...)</em>';
        setTimeout(() => speak(text, () => {}), 600);
        return;
      }

      const fragment = document.createDocumentFragment();
      const wordsAndSpace = text.split(/([^\s\w]+|\s+)/).filter(w => w !== ""); 
      
      let charIndex = 0;
      karaokeWords = [];

      wordsAndSpace.forEach(part => {
          if (!part.trim() || /^[.,!?;:"()]+$/.test(part)) {
              fragment.appendChild(document.createTextNode(part));
              charIndex += part.length;
              return;
          }

          const span = document.createElement('span');
          span.className = 'karaoke-word';
          span.textContent = part;
          span.dataset.start = charIndex;
          span.dataset.end = charIndex + part.length;
          
          if (globalLang !== 'vi-VN') {
              const tooltip = document.createElement('div');
              tooltip.className = 'word-tooltip';
              tooltip.textContent = "";
              span.appendChild(tooltip);
              span.addEventListener('mouseenter', () => translateSingleWord(part, tooltip));
          }

          karaokeWords.push(span);
          fragment.appendChild(span);
          charIndex += part.length;
      });

      els.segment.innerHTML = '';
      els.segment.appendChild(fragment);
      
      if (currentMode.includes('listen') && currentMode !== 'read-only') {
        setTimeout(() => speak(text, highlightKaraoke), 300);
      }
    }

    function highlightKaraoke(charIndex) {
      karaokeWords.forEach(w => w.classList.remove('karaoke-active'));
      const word = karaokeWords.find(w => charIndex >= w.dataset.start && charIndex < w.dataset.end);
      if (word) word.classList.add('karaoke-active');
    }

    function normalizeText(text) {
        return text.trim().replace(/[.,!?:;'"‚Äú‚Äù()[\]{}]/g, '').replace(/\s+/g, ' ').toLowerCase();
    }

    // === X·ª¨ L√ù G√ï PH√çM ===
    function updateFeedback() {
      const orig = segments[currentIdx];
      const input = els.input.value;
      const oWords = normalizeText(orig).split(/\s+/).filter(w => w);
      const iWords = normalizeText(input.replace(/ $/, ' \u00A0')).split(/\s+/).filter(w => w);
      
      let html = '', correct = 0;
      iWords.forEach((w, i) => {
        if (i >= oWords.length) html += `<span class="wrong">${w}</span> `;
        else if (w === oWords[i]) { correct++; html += `<span class="correct">${w}</span> `; }
        else html += `<span class="wrong">${w}</span> `;
      });
      correctWords = correct;
      els.feedback.innerHTML = html || '<em>Nh·∫≠p ƒë·ªÉ b·∫Øt ƒë·∫ßu...</em>';
      
      const isMatch = normalizeText(input) === normalizeText(orig);
      els.next.disabled = !isMatch;
      els.input.style.borderColor = isMatch ? 'var(--success)' : '';
      els.input.style.boxShadow = isMatch ? '0 0 0 4px rgba(16,185,129,0.25)' : '';
    }

    function next() {
      const wordsInSegment = normalizeText(segments[currentIdx]).split(/\s+/).filter(w => w).length;
      typedWords += wordsInSegment;
      totalCorrectWords += correctWords;
      currentIdx++;
      const p = (currentIdx / segments.length) * 100;
      els.progressFill.style.width = p + '%';
      els.progressText.textContent = Math.round(p) + '%';
      if (currentIdx >= segments.length) end(); else showSegment();
    }

    function updateStats() {
      const s = Math.floor((Date.now() - startTime) / 1000);
      els.time.textContent = s + 's';
      const m = s / 60;
      const wpm = m > 0 ? Math.round(typedWords / m) : 0;
      const acc = typedWords > 0 ? Math.round((totalCorrectWords / typedWords) * 100) : 100;
      els.wpm.textContent = wpm;
      els.acc.textContent = acc + '%';
    }

    function end() {
      clearInterval(timer);
      if (isListening) recognition?.stop();
      
      const s = (Date.now() - startTime) / 1000 / 60;
      const wpm = s > 0 ? Math.round(typedWords / s) : 0;
      const acc = typedWords > 0 ? Math.round((totalCorrectWords / typedWords) * 100) : 100;
      const score = Math.round(wpm * 2 + acc * 1.5 - hintsUsed * 5);
      const badge = wpm < 50 ? "T√¢n Binh" : wpm < 100 ? "Th√†nh Th·∫°o" : wpm < 200 ? "Cao Th·ªß" : "Huy·ªÅn Tho·∫°i";

      const name = playerName.trim() || '·∫®n danh';
      const entry = { name, date: new Date().toISOString(), wpm, acc, score, badge, sentences: totalSentences };
      
      personalHistory.push(entry);
      if (personalHistory.length > 10) personalHistory.shift();
      localStorage.setItem('personalHistory', JSON.stringify(personalHistory));
      
      if (!bestStats || entry.score > bestStats.score) {
          bestStats = entry;
          localStorage.setItem('bestStats', JSON.stringify(bestStats));
      }

      els.level.textContent = badge; els.levelBadge.textContent = 'ƒê·∫°t c·∫•p: ' + badge;
      els.score.textContent = score; els.wpm.textContent = wpm; els.acc.textContent = acc + '%';
      
      renderPersonalStats();
      alert(`Ho√†n th√†nh!\nT·ªëc ƒë·ªô: ${wpm} WPM\nƒêi·ªÉm: ${score}\nC·∫•p: ${badge}`);
    }

    function initSpeechRecognition() {
      if (recognition) { recognition.onend = null; recognition.stop(); }
      if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) return false;
      
      const SpeechRecognition = window.webkitSpeechRecognition || window.SpeechRecognition;
      recognition = new SpeechRecognition();
      recognition.lang = globalLang;
      recognition.continuous = false;
      recognition.interimResults = false;
      
      recognition.onresult = (e) => {
        const transcript = normalizeText(e.results[0][0].transcript);
        const target = normalizeText(segments[currentIdx]);
        const wordsTarget = target.split(/\s+/).filter(w => w);
        const wordsSaid = transcript.split(/\s+/).filter(w => w);
        
        let correct = 0;
        const feedback = wordsSaid.map((w, i) => {
          if (i >= wordsTarget.length) return `<span class="wrong">${w}</span>`;
          if (w === wordsTarget[i]) { correct++; return `<span class="correct">${w}</span>`; }
          return `<span class="wrong">${w}</span>`;
        }).join(' ');
        
        correctWords = correct;
        els.feedback.innerHTML = feedback || '<em>ƒêang nghe...</em>';
        const isMatch = (correct === wordsTarget.length) && (wordsSaid.length === wordsTarget.length);
        els.next.disabled = !isMatch;
        if(isMatch) els.feedback.innerHTML += "<br><em>(Tuy·ªát v·ªùi! Nh·∫•n 'Ti·∫øp theo')</em>";
      };
      
      recognition.onerror = () => {
        els.feedback.innerHTML = `<em>L·ªói mic. Nh·∫•n l·∫°i.</em>`;
        els.micBtn.classList.remove('listening');
        isListening = false;
      };
      recognition.onend = () => { els.micBtn.classList.remove('listening'); isListening = false; };
      return true;
    }

    // === 5. S·ª∞ KI·ªÜN ===
    els.loginBtn.addEventListener('click', () => {
      const name = els.usernameInput.value.trim();
      if (name) handleLogin(name); else alert('Vui l√≤ng nh·∫≠p t√™n!');
    });
    els.skipLoginBtn.addEventListener('click', () => handleLogin(coolNicknames[Math.floor(Math.random() * coolNicknames.length)]));
    els.logoutBtn.addEventListener('click', handleLogout);

    els.theme.addEventListener('click', toggleBaseTheme);
    els.holidayBtn.addEventListener('click', toggleHolidayMode);

    setupTabs(els.mainTabs(), els.tabContents());

    els.voiceSelect.addEventListener('change', () => {
        const voiceName = els.voiceSelect.value;
        selectedVoice = voices.find(v => v.name === voiceName);
        if (selectedVoice) localStorage.setItem('voice', selectedVoice.name);
    });
    els.previewVoice.addEventListener('click', () => speak(globalLang === 'vi-VN' ? 'Xin ch√†o, ƒë√¢y l√† gi·ªçng ƒë·ªçc th·ª≠.' : 'Hello, this is a voice preview.'));
    speechSynthesis.onvoiceschanged = loadVoices;

    els.lang.addEventListener('change', () => {
      globalLang = els.lang.value;
      localStorage.setItem('lang', globalLang);
      location.reload();
    });
    
    // AI BUTTON EVENT
    els.aiBtn.addEventListener('click', handleAIGeneration);

    els.start.addEventListener('click', () => {
      const text = els.text.value.trim();
      if (!text) return alert('Nh·∫≠p ƒëo·∫°n vƒÉn!');
      segments = text.split(/(?<=[.!?])\s+|\n+/).map(s => s.trim()).filter(s => s);
      if (!segments.length) return alert('Kh√¥ng c√≥ ƒëo·∫°n h·ª£p l·ªá!');
      
      currentIdx = 0; typedWords = 0; correctWords = 0; totalCorrectWords = 0; hintsUsed = 0; totalSentences = segments.length;
      currentMode = document.querySelector('input[name="mode"]:checked').value;
      
      speechRate = parseFloat(els.voiceRateSelect.value);
      
      els.modeBtns().forEach(btn => btn.classList.toggle('active', btn.dataset.mode === currentMode));
      
      startTime = Date.now(); 
      if (timer) clearInterval(timer);
      timer = setInterval(updateStats, 1000);
      
      document.getElementById('setupPanel').classList.add('hidden');
      document.getElementById('practiceArea').classList.remove('hidden');
      initSpeechRecognition();
      showSegment();
    });

    els.input.addEventListener('input', updateFeedback);
    els.input.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); if (!els.next.disabled) next(); } });
    els.hint.addEventListener('click', () => {
      const words = normalizeText(segments[currentIdx]).split(/\s+/).filter(w => w);
      const typed = normalizeText(els.input.value).split(/\s+/).filter(w => w);
      if (typed.length < words.length) {
        els.feedback.innerHTML += ` <span style="color:var(--info); font-weight:700;">‚Üí ${words[typed.length]}</span>`;
        hintsUsed++;
      }
    });
    
    els.replay.addEventListener('click', () => speak(segments[currentIdx], highlightKaraoke));
    els.next.addEventListener('click', next);
    els.reset.addEventListener('click', () => location.reload());

    els.modeBtns().forEach(btn => btn.addEventListener('click', () => {
        currentMode = btn.dataset.mode;
        els.modeBtns().forEach(b => b.classList.toggle('active', b.dataset.mode === currentMode));
        showSegment();
    }));

    els.micBtn.addEventListener('click', () => {
      if (!recognition && !initSpeechRecognition()) return;
      if (isListening) recognition.stop();
      else { recognition.start(); els.micBtn.classList.add('listening'); isListening = true; els.feedback.innerHTML = '<em>ƒêang nghe... H√£y ƒë·ªçc to!</em>'; }
    });

    // === 6. KH·ªûI CH·∫†Y ===
    initTheme(); 
    els.lang.value = globalLang;
    
    window.addEventListener('load', () => {
      checkLogin();
      renderPersonalStats();
      loadVoices();
    });
    setTimeout(loadVoices, 300);
  </script>
</body>
</html>
